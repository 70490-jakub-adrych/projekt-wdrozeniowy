{% extends 'crm/base.html' %}
{% load static %}

{% block title %}Panel Główny | System Helpdesk{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced dashboard components */
    .stat-card {
        border-radius: 0.75rem;
        overflow: hidden;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        height: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        cursor: pointer; /* Add pointer cursor to indicate clickable */
    }
    
    .stat-card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-card-count {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    /* Fix dashboard footer spacing */
    .container-fluid {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
    }
    
    .dashboard-content {
        padding-bottom: 0;
        margin-bottom: 0;
    }
    
    /* Card with hover effect */
    .card-hover {
        transition: all 0.3s ease;
    }
    
    .card-hover:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }
    
    /* Enhanced card styling to match logs page */
    .card {
        transition: all var(--transition-speed);
        border: none;
        box-shadow: var(--shadow-sm);
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .card:hover {
        box-shadow: var(--shadow-md);
    }
    
    /* Table enhancements */
    .table-sm td, .table-sm th {
        padding: 0.75rem 0.5rem;
    }
    
    .table {
        table-layout: fixed;
        width: 100%;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    
    .table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Column width settings */
    .col-id {
        width: 60px;
    }
    
    .col-title {
        width: 45%;
    }
    
    .col-priority, .col-status {
        width: 110px;
        text-align: center;
    }
    
    .col-date, .col-org, .col-user {
        width: 120px;
    }
    
    /* Quick action buttons - more compact */
    .quick-action-btn {
        transition: all 0.3s ease;
        border-radius: 0.5rem;
        padding: 0.75rem;  /* Reduced padding */
        text-align: center;
        display: flex;
        align-items: center;
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;  /* Slightly smaller font */
    }
    
    .quick-action-btn i {
        font-size: 1.1rem;  /* Slightly smaller icon */
        margin-right: 0.5rem;  /* Less space between icon and text */
        min-width: 1.1rem;  /* Fixed width for icons to align text */
    }
    
    /* Compact card headers with better icon alignment */
    .card-header {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
    }
    
    .card-header i {
        margin-right: 0.5rem;
        font-size: 0.9rem;
    }
    
    /* Make stat cards more compact */
    .stat-card-label {
        font-size: 0.85rem;
        margin-bottom: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Table column optimization */
    .table th, .table td {
        padding: 0.5rem 0.3rem;
        font-size: 0.9rem;
    }
    
    /* Add this new style for clickable card links */
    .stat-card-link {
        display: block;
        height: 100%;
        width: 100%;
        color: inherit;
        text-decoration: none;
    }

    .stat-card-link:hover {
        color: inherit;
        text-decoration: none;
    }
    
    /* Add animation for counter elements */
    .animate-counter {
        animation: fadeInUp 0.8s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Cool Icon Animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    @keyframes shake {
        0% { transform: translate(0, 0) rotate(0deg); }
        10% { transform: translate(-3px, -2px) rotate(-2deg); }
        20% { transform: translate(3px, 2px) rotate(1deg); }
        30% { transform: translate(-2px, 2px) rotate(-1deg); }
        40% { transform: translate(2px, -1px) rotate(2deg); }
        50% { transform: translate(-1px, 2px) rotate(-2deg); }
        60% { transform: translate(1px, 1px) rotate(1deg); }
        70% { transform: translate(-2px, -1px) rotate(-1deg); }
        80% { transform: translate(2px, 1px) rotate(2deg); }
        90% { transform: translate(-1px, -2px) rotate(-1deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
    }

    @keyframes jitterWarning {
        0% { transform: rotate(0deg) scale(1) translate(0, 0); }
        5% { transform: rotate(-3deg) scale(1.05) translate(-1px, 1px); }
        10% { transform: rotate(4deg) scale(0.95) translate(2px, -1px); }
        15% { transform: rotate(-2deg) scale(1.1) translate(-1px, -1px); }
        20% { transform: rotate(3deg) scale(0.9) translate(1px, 2px); }
        25% { transform: rotate(-4deg) scale(1.05) translate(-2px, 0px); }
        30% { transform: rotate(2deg) scale(0.95) translate(1px, -1px); }
        35% { transform: rotate(-1deg) scale(1.1) translate(0px, 1px); }
        40% { transform: rotate(5deg) scale(0.9) translate(2px, -2px); }
        45% { transform: rotate(-3deg) scale(1.05) translate(-1px, 1px); }
        50% { transform: rotate(2deg) scale(0.95) translate(1px, 0px); }
        55% { transform: rotate(-4deg) scale(1.1) translate(-2px, -1px); }
        60% { transform: rotate(3deg) scale(0.9) translate(1px, 1px); }
        65% { transform: rotate(-2deg) scale(1.05) translate(0px, -1px); }
        70% { transform: rotate(4deg) scale(0.95) translate(2px, 1px); }
        75% { transform: rotate(-1deg) scale(1.1) translate(-1px, 0px); }
        80% { transform: rotate(3deg) scale(0.9) translate(1px, -2px); }
        85% { transform: rotate(-3deg) scale(1.05) translate(-1px, 1px); }
        90% { transform: rotate(2deg) scale(0.95) translate(0px, 1px); }
        95% { transform: rotate(-1deg) scale(1.05) translate(1px, -1px); }
        100% { transform: rotate(0deg) scale(1) translate(0, 0); }
    }

    @keyframes lockShake {
        0% { transform: translateX(0) rotate(0deg); }
        10% { transform: translateX(-2px) rotate(-1deg); }
        20% { transform: translateX(2px) rotate(1deg); }
        30% { transform: translateX(-3px) rotate(-1deg); }
        40% { transform: translateX(3px) rotate(1deg); }
        50% { transform: translateX(-2px) rotate(-1deg); }
        60% { transform: translateX(2px) rotate(1deg); }
        70% { transform: translateX(-3px) rotate(-1deg); }
        80% { transform: translateX(3px) rotate(1deg); }
        90% { transform: translateX(-1px) rotate(-1deg); }
        100% { transform: translateX(0) rotate(0deg); }
    }

    @keyframes float {
        0% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0); }
    }

    /* Mobile-responsive enhancements */
    @media (max-width: 576px) {
        /* Stat cards mobile optimization */
        .stat-card {
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }
        
        .stat-card-count {
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }
        
        .stat-card-label {
            font-size: 0.9rem;
            line-height: 1.2;
        }
        
        /* Quick action buttons mobile */
        .quick-action-btn {
            padding: 1rem;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .quick-action-btn i {
            font-size: 1.3rem;
            margin-right: 0.75rem;
        }
        
        /* Card headers mobile */
        .card-header {
            padding: 1rem;
            font-size: 1.1rem;
        }
        
        .card-header i {
            font-size: 1.1rem;
            margin-right: 0.75rem;
        }
        
        /* Table mobile optimization */
        .table {
            font-size: 0.85rem;
        }
        
        .table th, .table td {
            padding: 0.75rem 0.5rem;
        }
        
        /* Hide desktop table, show mobile cards for dashboard tables */
        .dashboard-desktop-table {
            display: none !important;
        }
        
        .dashboard-mobile-cards {
            display: block !important;
        }
        
        .dashboard-mobile-card {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        
        .dashboard-mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .dashboard-mobile-card-id {
            font-weight: bold;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .dashboard-mobile-card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .dashboard-mobile-card-title a {
            text-decoration: none;
            color: inherit;
        }
        
        .dashboard-mobile-card-title a:hover {
            color: var(--accent-color);
        }
        
        .dashboard-mobile-card-field {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-mobile-card-label {
            font-weight: 600;
            color: #6c757d;
            margin-right: 0.5rem;
            min-width: 70px;
            font-size: 0.85rem;
        }
        
        .dashboard-mobile-card-value {
            text-align: right;
            font-size: 0.85rem;
        }
        
        /* Priority borders for mobile cards */
        .dashboard-mobile-priority-critical { border-left: 4px solid #dc3545; }
        .dashboard-mobile-priority-high { border-left: 4px solid #fd7e14; }
        .dashboard-mobile-priority-medium { border-left: 4px solid #0dcaf0; }
        .dashboard-mobile-priority-low { border-left: 4px solid #6c757d; }
    }
    
    /* Desktop styles */
    @media (min-width: 577px) {
        .dashboard-desktop-table {
            display: block !important;
        }
        
        .dashboard-mobile-cards {
            display: none !important;
        }
    }

    .animate-spin {
        animation: spin 2s linear infinite;
        animation-play-state: paused;
    }

    .animate-pulse {
        animation: pulse 1.5s ease-in-out infinite;
        animation-play-state: paused;
    }

    .animate-shake {
        animation: jitterWarning 2s ease-in-out infinite;
        animation-play-state: paused;
    }

    .animate-float {
        animation: float 3s ease-in-out infinite;
        animation-play-state: paused;
    }

    .animate-bounce {
        animation: lockShake 1.2s ease-in-out infinite;
        animation-play-state: paused;
    }

    /* Fix to disable Font Awesome animations until hover - PAUSE IN POSITION */
    .fa-spin {
        -webkit-animation: fa-spin 2s infinite linear;
        animation: fa-spin 2s infinite linear;
        animation-play-state: paused;
    }
    
    .stat-card:hover .fa-spin {
        animation-play-state: running !important;
    }
    
    /* Remove the existing animation definitions that might be running all the time */
    .animate-spin:not(.stat-card:hover *), 
    .animate-pulse:not(.stat-card:hover *), 
    .animate-shake:not(.stat-card:hover *),
    .animate-float:not(.stat-card:hover *),
    .animate-bounce:not(.stat-card:hover *) {
        animation-play-state: paused !important;
    }
    
    /* Animation only happens on stat-card hover */
    .stat-card:hover .animate-spin {
        animation: spin 2s linear infinite !important;
        animation-play-state: running !important;
    }
    
    .stat-card:hover .animate-pulse {
        animation: pulse 1.5s ease-in-out infinite !important;
        animation-play-state: running !important;
    }
    
    .stat-card:hover .animate-shake {
        animation: jitterWarning 2s ease-in-out infinite !important;
        animation-play-state: running !important;
    }
    
    .stat-card:hover .animate-float {
        animation: float 3s ease-in-out infinite !important;
        animation-play-state: running !important;
    }

    .stat-card:hover .animate-bounce {
        animation: lockShake 1.2s ease-in-out infinite !important;
        animation-play-state: running !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Include the 2FA warning -->
{% include 'crm/2fa/2fa_warning.html' %}

<div class="row mb-4">
    <div class="col">
        <h2 class="fw-bold">Panel Główny</h2>
    </div>
</div>

<!-- Quick Action buttons and Calendar - show for all users including clients -->
<div class="row mb-4">
    <!-- Quick Actions Column -->
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light">
                <i class="fas fa-bolt me-2"></i> Szybkie akcje
            </div>
            <div class="card-body pb-0">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'ticket_create' %}" class="quick-action-btn btn-ripple btn btn-primary d-block">
                            <i class="fas fa-plus"></i> Nowe zgłoszenie
                        </a>
                    </div>
                    
                    {% if resolved_tickets_count > 0 and user.profile.role == 'client' %}
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'ticket_list' %}?status=resolved&created_by=me" class="quick-action-btn btn-ripple btn btn-warning d-block">
                            <i class="fas fa-exclamation-circle"></i> Zgłoszenia do potwierdzenia ({{ resolved_tickets_count }})
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if pending_approvals > 0 and user.profile.role in 'admin,superagent,agent' %}
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'pending_approvals' %}" class="quick-action-btn btn-ripple btn btn-warning d-block">
                            <i class="fas fa-user-clock"></i> Oczekujące zatwierdzenia ({{ pending_approvals }})
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if user.profile.role == 'admin' or user.profile.role == 'superagent' %}
                    <div class="col-md-6 mb-3">
                        <a href="{% url 'organization_create' %}" class="quick-action-btn btn-ripple btn btn-success d-block">
                            <i class="fas fa-building"></i> Nowa organizacja
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendar Column - only for agents, superagents, and admins -->
    {% if user.profile.role in 'admin,superagent,agent' %}
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light">
                <i class="fas fa-calendar-alt me-2"></i> Kalendarz przypisań
            </div>
            <div class="card-body">
                <div id="dashboard-calendar"></div>
                <div class="text-center mt-2">
                    <small class="text-muted">Kliknij dzień, aby zobaczyć przypisane zgłoszenia</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Statistics summary for all roles -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <span><i class="fas fa-chart-pie me-2"></i> Statystyki zgłoszeń</span>
                    <div class="ms-auto">
                        {% if user.profile.role == 'admin' or user.profile.role == 'superagent' %}
                        <a href="{% url 'statistics_dashboard' %}" class="btn btn-sm btn-outline-primary btn-ripple">
                            <i class="fas fa-chart-line"></i> Szczegółowe statystyki
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <!-- Statistics Cards Layout:
                     Mobile: First card full width, then 2x2 grid for remaining 4
                     Desktop: All 5 cards in single row with equal width -->
                
                <!-- First card - Nowe -->
                <div class="row g-3 mb-3">
                    <div class="col-12 col-lg">
                        <div class="stat-card card bg-primary text-white">
                            <a href="{% url 'ticket_list' %}?status=new" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-file-alt animate-float"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ new_tickets }}">{{ new_tickets }}</div>
                                    <div class="stat-card-label">Nowe</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Remaining 4 cards on desktop only -->
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-info text-white">
                            <a href="{% url 'ticket_list' %}?status=in_progress" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-spinner fa-spin"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ in_progress_tickets }}">{{ in_progress_tickets }}</div>
                                    <div class="stat-card-label">W trakcie</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-warning">
                            <a href="{% url 'ticket_list' %}?status=unresolved" class="stat-card-link">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-exclamation-triangle animate-shake"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ unresolved_tickets }}">{{ unresolved_tickets }}</div>
                                    <div class="stat-card-label">Nierozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-success text-white">
                            <a href="{% url 'ticket_list' %}?status=resolved" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-check-circle animate-pulse"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ resolved_tickets }}">{{ resolved_tickets }}</div>
                                    <div class="stat-card-label">Rozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-secondary text-white">
                            <a href="{% url 'ticket_list' %}?status=closed" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-lock animate-bounce"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ closed_tickets }}">{{ closed_tickets }}</div>
                                    <div class="stat-card-label">Zamknięte</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile 2x2 grid for remaining 4 cards -->
                <div class="row g-3 d-lg-none">
                    <div class="col-6">
                        <div class="stat-card card bg-info text-white">
                            <a href="{% url 'ticket_list' %}?status=in_progress" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-spinner fa-spin"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ in_progress_tickets }}">{{ in_progress_tickets }}</div>
                                    <div class="stat-card-label">W trakcie</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card card bg-warning">
                            <a href="{% url 'ticket_list' %}?status=unresolved" class="stat-card-link">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-exclamation-triangle animate-shake"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ unresolved_tickets }}">{{ unresolved_tickets }}</div>
                                    <div class="stat-card-label">Nierozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card card bg-success text-white">
                            <a href="{% url 'ticket_list' %}?status=resolved" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-check-circle animate-pulse"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ resolved_tickets }}">{{ resolved_tickets }}</div>
                                    <div class="stat-card-label">Rozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card card bg-secondary text-white">
                            <a href="{% url 'ticket_list' %}?status=closed" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-lock animate-bounce"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ closed_tickets }}">{{ closed_tickets }}</div>
                                    <div class="stat-card-label">Zamknięte</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN PANELS -->
{% if user.profile.role == 'admin' %}
<div class="row">
    <!-- Admin Panel 1: Tickets awaiting approval -->
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-bell me-2"></i>
                Zgłoszenia oczekujące na akceptację
            </div>
            <div class="card-body p-0">
                {% if unassigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in unassigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak nieprzypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=unassigned&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel 2: Tickets in progress -->
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-tasks me-2"></i>
                Zgłoszenia w trakcie
            </div>
            <div class="card-body p-0">
                {% if in_progress_tickets_list %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-user">Przypisane do</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in in_progress_tickets_list %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}Nieprzypisane{% endif %}">
                                    {% if ticket.assigned_to %}
                                    <span class="d-inline-flex align-items-center">
                                        <i class="fas fa-user-check me-1 text-success"></i>
                                        {{ ticket.assigned_to.username }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted"><i class="fas fa-user-slash me-1"></i> Nieprzypisane</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń w trakcie realizacji.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?status=in_progress" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- SUPERAGENT PANELS -->
{% if user.profile.role == 'superagent' %}
<div class="row">
    <!-- Similar structure to admin panels but tailored for superagent -->
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-bell me-2"></i>
                Zgłoszenia oczekujące na akceptację
            </div>
            <div class="card-body p-0">
                {% if unassigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in unassigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak nieprzypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=unassigned&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-tasks me-2"></i>
                Zgłoszenia w trakcie
            </div>
            <div class="card-body p-0">
                {% if in_progress_tickets_list %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-user">Przypisane do</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in in_progress_tickets_list %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}Nieprzypisane{% endif %}">
                                    {% if ticket.assigned_to %}
                                    <span class="d-inline-flex align-items-center">
                                        <i class="fas fa-user-check me-1 text-success"></i>
                                        {{ ticket.assigned_to.username }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted"><i class="fas fa-user-slash me-1"></i> Nieprzypisane</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń w trakcie realizacji.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?status=in_progress" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- AGENT PANELS -->
{% if user.profile.role == 'agent' %}
<div class="row">
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-tasks me-2"></i>
                Zgłoszenia przypisane do mnie
            </div>
            <div class="card-body p-0">
                {% if assigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-priority">Priorytet</th>
                                <th class="col-status">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in assigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.status == 'new' %}bg-primary
                                        {% elif ticket.status == 'in_progress' %}bg-info
                                        {% elif ticket.status == 'waiting' %}bg-warning text-dark
                                        {% elif ticket.status == 'unresolved' %}bg-warning text-dark
                                        {% elif ticket.status == 'resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ticket.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak przypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=me&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-bell me-2"></i>
                Zgłoszenia oczekujące na akceptację
            </div>
            <div class="card-body p-0">
                {% if unassigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in unassigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak nieprzypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=unassigned&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- CLIENT PANELS -->
{% if user.profile.role == 'client' %}
<div class="row">
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-ticket-alt me-2"></i>
                Twoje ostatnie zgłoszenia
            </div>
            <div class="card-body p-0">
                {% if user_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-status">Status</th>
                                <th class="col-date">Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in user_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.status == 'new' %}bg-primary
                                        {% elif ticket.status == 'in_progress' %}bg-info
                                        {% elif ticket.status == 'waiting' %}bg-warning text-dark
                                        {% elif ticket.status == 'unresolved' %}bg-warning text-dark
                                        {% elif ticket.status == 'resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ticket.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ ticket.created_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-ticket-alt text-muted mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń utworzonych przez Ciebie.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?created_by=me&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-building me-2"></i>
                Zgłoszenia Twojej organizacji
            </div>
            <div class="card-body p-0">
                {% if org_recent_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-status">Status</th>
                                <th class="col-user">Utworzone przez</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in org_recent_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.status == 'new' %}bg-primary
                                        {% elif ticket.status == 'in_progress' %}bg-info
                                        {% elif ticket.status == 'waiting' %}bg-warning text-dark
                                        {% elif ticket.status == 'unresolved' %}bg-warning text-dark
                                        {% elif ticket.status == 'resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ticket.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ ticket.created_by.username }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-building text-muted mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń w Twojej organizacji.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?exclude_created_by=me&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recently Closed Tickets Section - common for all roles -->
<div class="row">
    <div class="col-md-12">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-check-circle me-2"></i> Ostatnio zamknięte zgłoszenia
            </div>
            <div class="card-body p-0">
                {% if recently_closed_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-date">Zamknięte</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in recently_closed_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>{{ ticket.closed_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-info-circle text-info mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zamkniętych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?status=closed" class="btn btn-sm btn-primary">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'crm/js/ui-enhancements.js' %}"></script>

{% if user.profile.role in 'admin,superagent,agent' %}
<style>
    #dashboard-calendar {
        font-family: Arial, sans-serif;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .calendar-header button {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px 10px;
        color: #007bff;
    }
    
    .calendar-header button:hover {
        color: #0056b3;
    }
    
    .calendar-month-year {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .calendar-day-header {
        text-align: center;
        font-weight: bold;
        padding: 8px 0;
        background-color: #e9ecef;
        font-size: 0.85rem;
    }
    
    .calendar-day {
        text-align: center;
        padding: 10px 5px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-height: 50px;
        position: relative;
        cursor: default;
        background-color: #fff;
    }
    
    .calendar-day.other-month {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    
    .calendar-day.weekend {
        background-color: #ffe6e6;
    }
    
    .calendar-day.today {
        background-color: #d1ecf1;
        border-color: #0c5460;
        font-weight: bold;
    }
    
    .calendar-day.has-assignments {
        background-color: #fff3cd;
        cursor: pointer;
    }
    
    .calendar-day.has-assignments:hover {
        background-color: #ffc107;
        border-color: #ff9800;
    }
    
    .calendar-day-number {
        font-size: 0.9rem;
    }
    
    .calendar-day-badge {
        position: absolute;
        top: 3px;
        right: 3px;
        background-color: #dc3545;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.7rem;
        font-weight: bold;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarContainer = document.getElementById('dashboard-calendar');
    
    if (!calendarContainer) return;
    
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth(); // 0-11
    
    const monthNames = [
        'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
        'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
    ];
    
    const dayNames = ['Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob', 'Nie'];
    
    let assignments = {};
    
    function renderCalendar(year, month) {
        // Clear container
        calendarContainer.innerHTML = '';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.innerHTML = `
            <button type="button" id="prev-month"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-month-year">${monthNames[month]} ${year}</span>
            <button type="button" id="next-month"><i class="fas fa-chevron-right"></i></button>
        `;
        calendarContainer.appendChild(header);
        
        // Create grid
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Add day headers
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });
        
        // Get first day of month (0 = Sunday, 1 = Monday, etc.)
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        // Adjust for Monday start (0 = Monday)
        const startDay = firstDay === 0 ? 6 : firstDay - 1;
        
        // Add previous month's days
        for (let i = startDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const dayDiv = createDayCell(day, true, false, year, month - 1);
            grid.appendChild(dayDiv);
        }
        
        // Add current month's days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = date.toDateString() === today.toDateString();
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const dayDiv = createDayCell(day, false, isToday, year, month, isWeekend);
            grid.appendChild(dayDiv);
        }
        
        // Fill remaining cells with next month's days
        const totalCells = grid.children.length - 7; // Subtract day headers
        const remainingCells = 42 - totalCells; // 6 weeks * 7 days
        for (let day = 1; day <= remainingCells; day++) {
            const dayDiv = createDayCell(day, true, false, year, month + 1);
            grid.appendChild(dayDiv);
        }
        
        calendarContainer.appendChild(grid);
        
        // Attach event listeners
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
            loadAssignments(currentYear, currentMonth + 1);
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
            loadAssignments(currentYear, currentMonth + 1);
        });
    }
    
    function createDayCell(day, isOtherMonth, isToday, year, month, isWeekend = false) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        if (isOtherMonth) {
            dayDiv.classList.add('other-month');
        } else {
            if (isToday) dayDiv.classList.add('today');
            if (isWeekend) dayDiv.classList.add('weekend');
            
            // Check for assignments
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            if (assignments[dateStr]) {
                dayDiv.classList.add('has-assignments');
                dayDiv.dataset.date = dateStr;
                
                // Add badge with count
                const badge = document.createElement('span');
                badge.className = 'calendar-day-badge';
                badge.textContent = assignments[dateStr].length;
                dayDiv.appendChild(badge);
                
                // Add click handler
                dayDiv.addEventListener('click', () => {
                    window.location.href = `/tickets/?calendar_date=${dateStr}`;
                });
                
                // Add tooltip
                const ticketTitles = assignments[dateStr].map(a => `• ${a.ticket_title}`).join('\n');
                dayDiv.title = `Przypisane zgłoszenia (${assignments[dateStr].length}):\n${ticketTitles}`;
            }
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        dayDiv.appendChild(dayNumber);
        
        return dayDiv;
    }
    
    function loadAssignments(year, month) {
        fetch(`/calendar/assignments/?year=${year}&month=${month}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                assignments = data.assignments;
                renderCalendar(currentYear, currentMonth);
            }
        })
        .catch(error => {
            console.error('Error loading calendar assignments:', error);
        });
    }
    
    // Initial render
    renderCalendar(currentYear, currentMonth);
    loadAssignments(currentYear, currentMonth + 1);
});
</script>
{% endif %}
{% endblock %}
