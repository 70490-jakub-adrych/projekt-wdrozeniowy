{% extends 'crm/base.html' %}
{% load static %}

{% block title %}Panel Główny | System Helpdesk{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced dashboard components */
    .stat-card {
        border-radius: 0.75rem;
        overflow: hidden;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        height: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        cursor: pointer; /* Add pointer cursor to indicate clickable */
    }
    
    .stat-card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-card-count {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    /* Fix dashboard footer spacing */
    .container-fluid {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
    }
    
    .dashboard-content {
        padding-bottom: 0;
        margin-bottom: 0;
    }
    
    /* Card with hover effect */
    .card-hover {
        transition: all 0.3s ease;
    }
    
    .card-hover:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }
    
    /* Enhanced card styling to match logs page */
    .card {
        transition: all var(--transition-speed);
        border: none;
        box-shadow: var(--shadow-sm);
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .card:hover {
        box-shadow: var(--shadow-md);
    }
    
    /* Table enhancements */
    .table-sm td, .table-sm th {
        padding: 0.75rem 0.5rem;
    }
    
    .table {
        table-layout: fixed;
        width: 100%;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    
    .table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Column width settings */
    .col-id {
        width: 60px;
    }
    
    .col-title {
        width: 45%;
    }
    
    .col-priority, .col-status {
        width: 110px;
        text-align: center;
    }
    
    .col-date, .col-org, .col-user {
        width: 120px;
    }
    
    /* Quick action buttons - more compact */
    .quick-action-btn {
        transition: all 0.3s ease;
        border-radius: 0.5rem;
        padding: 0.75rem;  /* Reduced padding */
        text-align: center;
        display: flex;
        align-items: center;
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;  /* Slightly smaller font */
    }
    
    .quick-action-btn i {
        font-size: 1.1rem;  /* Slightly smaller icon */
        margin-right: 0.5rem;  /* Less space between icon and text */
        min-width: 1.1rem;  /* Fixed width for icons to align text */
    }
    
    /* Compact card headers with better icon alignment */
    .card-header {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
    }
    
    .card-header i {
        margin-right: 0.5rem;
        font-size: 0.9rem;
    }
    
    /* Make stat cards more compact */
    .stat-card-label {
        font-size: 0.85rem;
        margin-bottom: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Table column optimization */
    .table th, .table td {
        padding: 0.5rem 0.3rem;
        font-size: 0.9rem;
    }
    
    /* Add this new style for clickable card links */
    .stat-card-link {
        display: block;
        height: 100%;
        width: 100%;
        color: inherit;
        text-decoration: none;
    }

    .stat-card-link:hover {
        color: inherit;
        text-decoration: none;
    }
    
    /* Add animation for counter elements */
    .animate-counter {
        animation: fadeInUp 0.8s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Cool Icon Animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    @keyframes shake {
        0% { transform: translate(0, 0) rotate(0deg); }
        10% { transform: translate(-3px, -2px) rotate(-2deg); }
        20% { transform: translate(3px, 2px) rotate(1deg); }
        30% { transform: translate(-2px, 2px) rotate(-1deg); }
        40% { transform: translate(2px, -1px) rotate(2deg); }
        50% { transform: translate(-1px, 2px) rotate(-2deg); }
        60% { transform: translate(1px, 1px) rotate(1deg); }
        70% { transform: translate(-2px, -1px) rotate(-1deg); }
        80% { transform: translate(2px, 1px) rotate(2deg); }
        90% { transform: translate(-1px, -2px) rotate(-1deg); }
        100% { transform: translate(0, 0) rotate(0deg); }
    }

    @keyframes jitterWarning {
        0% { transform: rotate(0deg) scale(1) translate(0, 0); }
        5% { transform: rotate(-3deg) scale(1.05) translate(-1px, 1px); }
        10% { transform: rotate(4deg) scale(0.95) translate(2px, -1px); }
        15% { transform: rotate(-2deg) scale(1.1) translate(-1px, -1px); }
        20% { transform: rotate(3deg) scale(0.9) translate(1px, 2px); }
        25% { transform: rotate(-4deg) scale(1.05) translate(-2px, 0px); }
        30% { transform: rotate(2deg) scale(0.95) translate(1px, -1px); }
        35% { transform: rotate(-1deg) scale(1.1) translate(0px, 1px); }
        40% { transform: rotate(5deg) scale(0.9) translate(2px, -2px); }
        45% { transform: rotate(-3deg) scale(1.05) translate(-1px, 1px); }
        50% { transform: rotate(2deg) scale(0.95) translate(1px, 0px); }
        55% { transform: rotate(-4deg) scale(1.1) translate(-2px, -1px); }
        60% { transform: rotate(3deg) scale(0.9) translate(1px, 1px); }
        65% { transform: rotate(-2deg) scale(1.05) translate(0px, -1px); }
        70% { transform: rotate(4deg) scale(0.95) translate(2px, 1px); }
        75% { transform: rotate(-1deg) scale(1.1) translate(-1px, 0px); }
        80% { transform: rotate(3deg) scale(0.9) translate(1px, -2px); }
        85% { transform: rotate(-3deg) scale(1.05) translate(-1px, 1px); }
        90% { transform: rotate(2deg) scale(0.95) translate(0px, 1px); }
        95% { transform: rotate(-1deg) scale(1.05) translate(1px, -1px); }
        100% { transform: rotate(0deg) scale(1) translate(0, 0); }
    }

    @keyframes lockShake {
        0% { transform: translateX(0) rotate(0deg); }
        10% { transform: translateX(-2px) rotate(-1deg); }
        20% { transform: translateX(2px) rotate(1deg); }
        30% { transform: translateX(-3px) rotate(-1deg); }
        40% { transform: translateX(3px) rotate(1deg); }
        50% { transform: translateX(-2px) rotate(-1deg); }
        60% { transform: translateX(2px) rotate(1deg); }
        70% { transform: translateX(-3px) rotate(-1deg); }
        80% { transform: translateX(3px) rotate(1deg); }
        90% { transform: translateX(-1px) rotate(-1deg); }
        100% { transform: translateX(0) rotate(0deg); }
    }

    @keyframes float {
        0% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0); }
    }

    /* Mobile-responsive enhancements */
    @media (max-width: 576px) {
        /* Stat cards mobile optimization */
        .stat-card {
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }
        
        .stat-card-count {
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }
        
        .stat-card-label {
            font-size: 0.9rem;
            line-height: 1.2;
        }
        
        /* Quick action buttons mobile */
        .quick-action-btn {
            padding: 1rem;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .quick-action-btn i {
            font-size: 1.3rem;
            margin-right: 0.75rem;
        }
        
        /* Card headers mobile */
        .card-header {
            padding: 1rem;
            font-size: 1.1rem;
        }
        
        .card-header i {
            font-size: 1.1rem;
            margin-right: 0.75rem;
        }
        
        /* Table mobile optimization */
        .table {
            font-size: 0.85rem;
        }
        
        .table th, .table td {
            padding: 0.75rem 0.5rem;
        }
        
        /* Hide desktop table, show mobile cards for dashboard tables */
        .dashboard-desktop-table {
            display: none !important;
        }
        
        .dashboard-mobile-cards {
            display: block !important;
        }
        
        .dashboard-mobile-card {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        
        .dashboard-mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .dashboard-mobile-card-id {
            font-weight: bold;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .dashboard-mobile-card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .dashboard-mobile-card-title a {
            text-decoration: none;
            color: inherit;
        }
        
        .dashboard-mobile-card-title a:hover {
            color: var(--accent-color);
        }
        
        .dashboard-mobile-card-field {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-mobile-card-label {
            font-weight: 600;
            color: #6c757d;
            margin-right: 0.5rem;
            min-width: 70px;
            font-size: 0.85rem;
        }
        
        .dashboard-mobile-card-value {
            text-align: right;
            font-size: 0.85rem;
        }
        
        /* Priority borders for mobile cards */
        .dashboard-mobile-priority-critical { border-left: 4px solid #dc3545; }
        .dashboard-mobile-priority-high { border-left: 4px solid #fd7e14; }
        .dashboard-mobile-priority-medium { border-left: 4px solid #0dcaf0; }
        .dashboard-mobile-priority-low { border-left: 4px solid #6c757d; }
    }
    
    /* Desktop styles */
    @media (min-width: 577px) {
        .dashboard-desktop-table {
            display: block !important;
        }
        
        .dashboard-mobile-cards {
            display: none !important;
        }
    }

    .animate-spin {
        animation: spin 2s linear infinite;
        animation-play-state: paused;
    }

    .animate-pulse {
        animation: pulse 1.5s ease-in-out infinite;
        animation-play-state: paused;
    }

    .animate-shake {
        animation: jitterWarning 2s ease-in-out infinite;
        animation-play-state: paused;
    }

    .animate-float {
        animation: float 3s ease-in-out infinite;
        animation-play-state: paused;
    }

    .animate-bounce {
        animation: lockShake 1.2s ease-in-out infinite;
        animation-play-state: paused;
    }

    /* Fix to disable Font Awesome animations until hover - PAUSE IN POSITION */
    .fa-spin {
        -webkit-animation: fa-spin 2s infinite linear;
        animation: fa-spin 2s infinite linear;
        animation-play-state: paused;
    }
    
    .stat-card:hover .fa-spin {
        animation-play-state: running !important;
    }
    
    /* Remove the existing animation definitions that might be running all the time */
    .animate-spin:not(.stat-card:hover *), 
    .animate-pulse:not(.stat-card:hover *), 
    .animate-shake:not(.stat-card:hover *),
    .animate-float:not(.stat-card:hover *),
    .animate-bounce:not(.stat-card:hover *) {
        animation-play-state: paused !important;
    }
    
    /* Animation only happens on stat-card hover */
    .stat-card:hover .animate-spin {
        animation: spin 2s linear infinite !important;
        animation-play-state: running !important;
    }
    
    .stat-card:hover .animate-pulse {
        animation: pulse 1.5s ease-in-out infinite !important;
        animation-play-state: running !important;
    }
    
    .stat-card:hover .animate-shake {
        animation: jitterWarning 2s ease-in-out infinite !important;
        animation-play-state: running !important;
    }
    
    .stat-card:hover .animate-float {
        animation: float 3s ease-in-out infinite !important;
        animation-play-state: running !important;
    }

    .stat-card:hover .animate-bounce {
        animation: lockShake 1.2s ease-in-out infinite !important;
        animation-play-state: running !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Include the 2FA warning -->
{% include 'crm/2fa/2fa_warning.html' %}

<div class="row mb-4">
    <div class="col">
        <h2 class="fw-bold">Panel Główny</h2>
    </div>
</div>

<!-- Quick Action buttons and Calendar - show for all users including clients -->
<div class="row mb-4">
    <!-- Quick Actions Column - 1/3 width -->
    <div class="col-lg-4 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <i class="fas fa-bolt me-2"></i> Szybkie akcje
            </div>
            <div class="card-body">
                <!-- Buttons stacked vertically -->
                <a href="{% url 'ticket_create' %}" class="quick-action-btn btn-ripple btn btn-primary d-block mb-3">
                    <i class="fas fa-plus"></i> Nowe zgłoszenie
                </a>
                
                {% if resolved_tickets_count > 0 and user.profile.role == 'client' %}
                <a href="{% url 'ticket_list' %}?status=resolved&created_by=me" class="quick-action-btn btn-ripple btn btn-warning d-block mb-3">
                    <i class="fas fa-exclamation-circle"></i> Zgłoszenia do potwierdzenia ({{ resolved_tickets_count }})
                </a>
                {% endif %}
                
                {% if pending_approvals > 0 and user.profile.role in 'admin,superagent,agent' %}
                <a href="{% url 'pending_approvals' %}" class="quick-action-btn btn-ripple btn btn-warning d-block mb-3">
                    <i class="fas fa-user-clock"></i> Oczekujące zatwierdzenia ({{ pending_approvals }})
                </a>
                {% endif %}
                
                {% if user.profile.role == 'admin' or user.profile.role == 'superagent' %}
                <a href="{% url 'organization_create' %}" class="quick-action-btn btn-ripple btn btn-success d-block mb-3">
                    <i class="fas fa-building"></i> Nowa organizacja
                </a>
                <a href="{% url 'generate_duties' %}" class="quick-action-btn btn-ripple btn btn-info d-block mb-3">
                    <i class="fas fa-calendar-week"></i> Generuj dyżury
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Calendar Column - 2/3 width for agents, superagents, and admins -->
    {% if user.profile.role in 'admin,superagent,agent' %}
    <div class="col-lg-8 mb-3">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <i class="fas fa-calendar-alt me-2"></i> Kalendarz przypisań
            </div>
            <div class="card-body">
                <div id="dashboard-calendar"></div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <span class="badge bg-success me-1">●</span> Zgłoszenia
                        <span class="badge bg-info ms-2 me-1">●</span> Notatki
                        <br>Kliknij dzień z notatką/zgłoszeniem aby zobaczyć szczegóły
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Statistics summary for all roles -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <span><i class="fas fa-chart-pie me-2"></i> Statystyki zgłoszeń</span>
                    <div class="ms-auto">
                        {% if user.profile.role == 'admin' or user.profile.role == 'superagent' %}
                        <a href="{% url 'statistics_dashboard' %}" class="btn btn-sm btn-outline-primary btn-ripple">
                            <i class="fas fa-chart-line"></i> Szczegółowe statystyki
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <!-- Statistics Cards Layout:
                     Mobile: First card full width, then 2x2 grid for remaining 4
                     Desktop: All 5 cards in single row with equal width -->
                
                <!-- First card - Nowe -->
                <div class="row g-3 mb-3">
                    <div class="col-12 col-lg">
                        <div class="stat-card card bg-primary text-white">
                            <a href="{% url 'ticket_list' %}?status=new" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-file-alt animate-float"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ new_tickets }}">{{ new_tickets }}</div>
                                    <div class="stat-card-label">Nowe</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Remaining 4 cards on desktop only -->
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-info text-white">
                            <a href="{% url 'ticket_list' %}?status=in_progress" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-spinner fa-spin"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ in_progress_tickets }}">{{ in_progress_tickets }}</div>
                                    <div class="stat-card-label">W trakcie</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-warning">
                            <a href="{% url 'ticket_list' %}?status=unresolved" class="stat-card-link">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-exclamation-triangle animate-shake"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ unresolved_tickets }}">{{ unresolved_tickets }}</div>
                                    <div class="stat-card-label">Nierozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-success text-white">
                            <a href="{% url 'ticket_list' %}?status=resolved" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-check-circle animate-pulse"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ resolved_tickets }}">{{ resolved_tickets }}</div>
                                    <div class="stat-card-label">Rozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg d-none d-lg-block">
                        <div class="stat-card card bg-secondary text-white">
                            <a href="{% url 'ticket_list' %}?status=closed" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-lock animate-bounce"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ closed_tickets }}">{{ closed_tickets }}</div>
                                    <div class="stat-card-label">Zamknięte</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile 2x2 grid for remaining 4 cards -->
                <div class="row g-3 d-lg-none">
                    <div class="col-6">
                        <div class="stat-card card bg-info text-white">
                            <a href="{% url 'ticket_list' %}?status=in_progress" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-spinner fa-spin"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ in_progress_tickets }}">{{ in_progress_tickets }}</div>
                                    <div class="stat-card-label">W trakcie</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card card bg-warning">
                            <a href="{% url 'ticket_list' %}?status=unresolved" class="stat-card-link">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-exclamation-triangle animate-shake"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ unresolved_tickets }}">{{ unresolved_tickets }}</div>
                                    <div class="stat-card-label">Nierozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card card bg-success text-white">
                            <a href="{% url 'ticket_list' %}?status=resolved" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-check-circle animate-pulse"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ resolved_tickets }}">{{ resolved_tickets }}</div>
                                    <div class="stat-card-label">Rozwiązane</div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card card bg-secondary text-white">
                            <a href="{% url 'ticket_list' %}?status=closed" class="stat-card-link text-white">
                                <div class="card-body text-center py-3">
                                    <div class="stat-card-icon"><i class="fas fa-lock animate-bounce"></i></div>
                                    <div class="stat-card-count animate-counter" data-count="{{ closed_tickets }}">{{ closed_tickets }}</div>
                                    <div class="stat-card-label">Zamknięte</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN PANELS -->
{% if user.profile.role == 'admin' %}
<div class="row">
    <!-- Admin Panel 1: Tickets awaiting approval -->
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-bell me-2"></i>
                Zgłoszenia oczekujące na akceptację
            </div>
            <div class="card-body p-0">
                {% if unassigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in unassigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak nieprzypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=unassigned&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel 2: Tickets in progress -->
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-tasks me-2"></i>
                Zgłoszenia w trakcie
            </div>
            <div class="card-body p-0">
                {% if in_progress_tickets_list %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-user">Przypisane do</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in in_progress_tickets_list %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}Nieprzypisane{% endif %}">
                                    {% if ticket.assigned_to %}
                                    <span class="d-inline-flex align-items-center">
                                        <i class="fas fa-user-check me-1 text-success"></i>
                                        {{ ticket.assigned_to.username }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted"><i class="fas fa-user-slash me-1"></i> Nieprzypisane</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń w trakcie realizacji.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?status=in_progress" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- SUPERAGENT PANELS -->
{% if user.profile.role == 'superagent' %}
<div class="row">
    <!-- Similar structure to admin panels but tailored for superagent -->
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-bell me-2"></i>
                Zgłoszenia oczekujące na akceptację
            </div>
            <div class="card-body p-0">
                {% if unassigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in unassigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak nieprzypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=unassigned&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-tasks me-2"></i>
                Zgłoszenia w trakcie
            </div>
            <div class="card-body p-0">
                {% if in_progress_tickets_list %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-user">Przypisane do</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in in_progress_tickets_list %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}Nieprzypisane{% endif %}">
                                    {% if ticket.assigned_to %}
                                    <span class="d-inline-flex align-items-center">
                                        <i class="fas fa-user-check me-1 text-success"></i>
                                        {{ ticket.assigned_to.username }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted"><i class="fas fa-user-slash me-1"></i> Nieprzypisane</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń w trakcie realizacji.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?status=in_progress" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- AGENT PANELS -->
{% if user.profile.role == 'agent' %}
<div class="row">
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-tasks me-2"></i>
                Zgłoszenia przypisane do mnie
            </div>
            <div class="card-body p-0">
                {% if assigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-priority">Priorytet</th>
                                <th class="col-status">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in assigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.status == 'new' %}bg-primary
                                        {% elif ticket.status == 'in_progress' %}bg-info
                                        {% elif ticket.status == 'waiting' %}bg-warning text-dark
                                        {% elif ticket.status == 'unresolved' %}bg-warning text-dark
                                        {% elif ticket.status == 'resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ticket.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak przypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=me&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-bell me-2"></i>
                Zgłoszenia oczekujące na akceptację
            </div>
            <div class="card-body p-0">
                {% if unassigned_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-priority">Priorytet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in unassigned_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.priority == 'low' %}bg-secondary
                                        {% elif ticket.priority == 'medium' %}bg-info
                                        {% elif ticket.priority == 'high' %}bg-warning
                                        {% elif ticket.priority == 'critical' %}bg-danger{% endif %}">
                                        {{ ticket.get_priority_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                    <p>Brak nieprzypisanych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?assigned=unassigned&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- CLIENT PANELS -->
{% if user.profile.role == 'client' %}
<div class="row">
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-ticket-alt me-2"></i>
                Twoje ostatnie zgłoszenia
            </div>
            <div class="card-body p-0">
                {% if user_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-status">Status</th>
                                <th class="col-date">Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in user_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.status == 'new' %}bg-primary
                                        {% elif ticket.status == 'in_progress' %}bg-info
                                        {% elif ticket.status == 'waiting' %}bg-warning text-dark
                                        {% elif ticket.status == 'unresolved' %}bg-warning text-dark
                                        {% elif ticket.status == 'resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ticket.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ ticket.created_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-ticket-alt text-muted mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń utworzonych przez Ciebie.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?created_by=me&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-building me-2"></i>
                Zgłoszenia Twojej organizacji
            </div>
            <div class="card-body p-0">
                {% if org_recent_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-status">Status</th>
                                <th class="col-user">Utworzone przez</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in org_recent_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td>
                                    <span class="badge 
                                        {% if ticket.status == 'new' %}bg-primary
                                        {% elif ticket.status == 'in_progress' %}bg-info
                                        {% elif ticket.status == 'waiting' %}bg-warning text-dark
                                        {% elif ticket.status == 'unresolved' %}bg-warning text-dark
                                        {% elif ticket.status == 'resolved' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ ticket.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ ticket.created_by.username }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-building text-muted mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zgłoszeń w Twojej organizacji.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?exclude_created_by=me&exclude_closed=true" class="btn btn-sm btn-primary btn-ripple">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recently Closed Tickets Section - common for all roles -->
<div class="row">
    <div class="col-md-12">
        <div class="card card-hover shadow-sm mb-4">
            <div class="card-header bg-light">
                <i class="fas fa-check-circle me-2"></i> Ostatnio zamknięte zgłoszenia
            </div>
            <div class="card-body p-0">
                {% if recently_closed_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-id">ID</th>
                                <th class="col-title">Tytuł</th>
                                <th class="col-org">Organizacja</th>
                                <th class="col-date">Zamknięte</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in recently_closed_tickets %}
                            <tr>
                                <td>#{{ ticket.id }}</td>
                                <td title="{{ ticket.title }}"><a href="{% url 'ticket_detail' ticket.pk %}" class="text-decoration-none">{{ ticket.title }}</a></td>
                                <td title="{{ ticket.organization.name }}">{{ ticket.organization.name }}</td>
                                <td>{{ ticket.closed_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-4 text-center">
                    <i class="fas fa-info-circle text-info mb-3" style="font-size: 2rem;"></i>
                    <p>Brak zamkniętych zgłoszeń.</p>
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-white">
                <a href="{% url 'ticket_list' %}?status=closed" class="btn btn-sm btn-primary">
                    <i class="fas fa-list me-1"></i> Zobacz wszystkie
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Note Modal -->
{% if user.profile.role in 'admin,superagent,agent' %}
<div class="modal fade" id="calendarNoteModal" tabindex="-1" aria-labelledby="calendarNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarNoteModalLabel">
                    <i class="fas fa-sticky-note me-2"></i><span id="noteModalTitle">Notatki i zgłoszenia</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="noteModalDate" class="alert alert-info mb-3"></div>
                
                <!-- Duty Section (only for superagent/admin) -->
                {% if user.profile.role in 'admin,superagent' %}
                <div id="dutySection" class="mb-4" style="display: none;">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-user-shield text-primary me-2"></i>Dyżur
                    </h6>
                    <div id="dutyInfo" class="alert alert-info"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="changeDuty()">
                        <i class="fas fa-exchange-alt me-1"></i>Zmień osobę dyżurującą
                    </button>
                </div>
                {% endif %}
                
                <!-- Assignments Section -->
                <div id="assignmentsSection" class="mb-4" style="display: none;">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-ticket-alt text-success me-2"></i>Przypisane zgłoszenia
                    </h6>
                    <div id="assignmentsList"></div>
                </div>
                
                <!-- Notes Section -->
                <div id="notesSection">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-sticky-note text-info me-2"></i>Twoje notatki
                    </h6>
                    <div id="notesList"></div>
                    
                    <!-- Add Note Form -->
                    <div id="addNoteForm" class="card bg-light mt-3" style="display: none;">
                        <div class="card-body">
                            <div class="mb-2">
                                <label for="noteTitle" class="form-label">Tytuł notatki</label>
                                <input type="text" class="form-control form-control-sm" id="noteTitle" placeholder="Wpisz tytuł..." maxlength="200">
                            </div>
                            <div class="mb-2">
                                <label for="noteContent" class="form-label">Treść (opcjonalnie)</label>
                                <textarea class="form-control form-control-sm" id="noteContent" rows="3" placeholder="Wpisz szczegóły..."></textarea>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="noteIsPrivate" checked>
                                <label class="form-check-label" for="noteIsPrivate">
                                    <i class="fas fa-lock me-1"></i>Tylko dla mnie
                                </label>
                                <small class="form-text text-muted d-block">Odznacz, aby udostępnić notatkę innym pracownikom</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary" onclick="saveNote()">
                                    <i class="fas fa-save me-1"></i>Zapisz
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelNoteForm()">
                                    <i class="fas fa-times me-1"></i>Anuluj
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Note Form -->
                    <div id="editNoteForm" class="card bg-light mt-3" style="display: none;">
                        <div class="card-body">
                            <input type="hidden" id="editNoteId">
                            <div class="mb-2">
                                <label for="editNoteTitle" class="form-label">Tytuł notatki</label>
                                <input type="text" class="form-control form-control-sm" id="editNoteTitle" placeholder="Wpisz tytuł..." maxlength="200">
                            </div>
                            <div class="mb-2">
                                <label for="editNoteContent" class="form-label">Treść (opcjonalnie)</label>
                                <textarea class="form-control form-control-sm" id="editNoteContent" rows="3" placeholder="Wpisz szczegóły..."></textarea>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="editNoteIsPrivate">
                                <label class="form-check-label" for="editNoteIsPrivate">
                                    <i class="fas fa-lock me-1"></i>Tylko dla mnie
                                </label>
                                <small class="form-text text-muted d-block">Odznacz, aby udostępnić notatkę innym pracownikom</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary" onclick="updateNote()">
                                    <i class="fas fa-save me-1"></i>Zapisz
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEditForm()">
                                    <i class="fas fa-times me-1"></i>Anuluj
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2 w-100" id="addNoteBtn" onclick="showAddNoteForm()">
                        <i class="fas fa-plus me-1"></i>Dodaj notatkę
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'crm/js/ui-enhancements.js' %}"></script>

{% if user.profile.role in 'admin,superagent,agent' %}
<style>
    #dashboard-calendar {
        font-family: Arial, sans-serif;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .calendar-header button {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px 10px;
        color: #007bff;
    }
    
    .calendar-header button:hover {
        color: #0056b3;
    }
    
    .calendar-month-year {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .calendar-day-header {
        text-align: center;
        font-weight: bold;
        padding: 8px 0;
        background-color: #e9ecef;
        font-size: 0.85rem;
    }
    
    .calendar-day {
        text-align: center;
        padding: 10px 5px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-height: 50px;
        position: relative;
        cursor: pointer;
        background-color: #fff;
        transition: all 0.2s ease;
    }
    
    .calendar-day:not(.other-month):hover {
        border-color: #adb5bd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .calendar-day.other-month {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: default;
    }
    
    .calendar-day.weekend {
        background-color: #ffe6e6;
    }
    
    .calendar-day.today {
        background-color: #d1ecf1;
        border-color: #0c5460;
        font-weight: bold;
    }
    
    .calendar-day.has-assignments {
        background-color: #d4edda;
        cursor: pointer;
        border-left: 3px solid #28a745;
    }
    
    .calendar-day.has-assignments:hover {
        background-color: #c3e6cb;
        border-color: #28a745;
    }
    
    .calendar-day.has-notes {
        background-color: #cfe2ff;
        cursor: pointer;
        border-left: 3px solid #0d6efd;
    }
    
    .calendar-day.has-notes:hover {
        background-color: #9ec5fe;
        border-color: #0d6efd;
    }
    
    .calendar-day.has-assignments.has-notes {
        background: linear-gradient(135deg, #d4edda 50%, #cfe2ff 50%);
        border-left: 3px solid #28a745;
        border-right: 3px solid #0d6efd;
    }
    
    .calendar-day.has-assignments.has-notes:hover {
        background: linear-gradient(135deg, #c3e6cb 50%, #9ec5fe 50%);
    }
    
    .calendar-day-number {
        font-size: 0.9rem;
    }
    
    .calendar-day-badge {
        position: absolute;
        top: 3px;
        right: 3px;
        background-color: #28a745;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.7rem;
        font-weight: bold;
    }
    
    .calendar-day-badge.notes-badge {
        background-color: #0d6efd;
        right: auto;
        left: 3px;
    }
    
    .calendar-day-badge.assignments-badge {
        background-color: #28a745;
    }
    
    /* Dark mode styles for calendar */
    [data-theme="dark"] .calendar-header {
        background-color: #343a40 !important;
    }
    
    [data-theme="dark"] .calendar-header button {
        color: #0d6efd !important;
    }
    
    [data-theme="dark"] .calendar-header button:hover {
        color: #6ea8fe !important;
    }
    
    [data-theme="dark"] .calendar-month-year {
        color: #f8f9fa !important;
    }
    
    [data-theme="dark"] .calendar-day-header {
        background-color: #495057 !important;
        color: #dee2e6 !important;
    }
    
    [data-theme="dark"] .calendar-day {
        background-color: #212529 !important;
        border-color: #495057 !important;
        color: #dee2e6 !important;
    }
    
    [data-theme="dark"] .calendar-day:not(.other-month):hover {
        border-color: #6c757d !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
    }
    
    [data-theme="dark"] .calendar-day.other-month {
        background-color: #1a1d20 !important;
        color: #6c757d !important;
    }
    
    [data-theme="dark"] .calendar-day.weekend {
        background-color: #3d1f1f !important;
    }
    
    [data-theme="dark"] .calendar-day.today {
        background-color: #0c4a6e !important;
        border-color: #0ea5e9 !important;
        color: #f8f9fa !important;
    }
    
    [data-theme="dark"] .calendar-day.has-assignments {
        background-color: #1e4620 !important;
        border-left-color: #28a745 !important;
        color: #fff !important;
    }
    
    [data-theme="dark"] .calendar-day.has-assignments:hover {
        background-color: #2d5a2f !important;
        border-color: #28a745 !important;
    }
    
    [data-theme="dark"] .calendar-day.has-notes {
        background-color: #0c2340 !important;
        border-left-color: #0d6efd !important;
        color: #fff !important;
    }
    
    [data-theme="dark"] .calendar-day.has-notes:hover {
        background-color: #153055 !important;
        border-color: #0d6efd !important;
    }
    
    [data-theme="dark"] .calendar-day.has-assignments.has-notes {
        background: linear-gradient(135deg, #1e4620 50%, #0c2340 50%) !important;
        border-left-color: #28a745 !important;
        border-right-color: #0d6efd !important;
    }
    
    [data-theme="dark"] .calendar-day.has-assignments.has-notes:hover {
        background: linear-gradient(135deg, #2d5a2f 50%, #153055 50%) !important;
    }
    
    [data-theme="dark"] .calendar-day-badge {
        background-color: #28a745 !important;
    }
    
    [data-theme="dark"] .calendar-day-badge.notes-badge {
        background-color: #0d6efd !important;
    }
    
    [data-theme="dark"] .calendar-day-badge.assignments-badge {
        background-color: #28a745 !important;
    }
    
    /* Mobile responsive for calendar */
    @media (max-width: 991px) {
        .calendar-grid {
            gap: 3px;
        }
        
        .calendar-day {
            min-height: 40px;
            padding: 5px 2px;
            font-size: 0.85rem;
        }
        
        .calendar-day-number {
            font-size: 0.8rem;
        }
        
        .calendar-day-badge {
            font-size: 0.6rem;
            padding: 1px 4px;
        }
        
        .calendar-header {
            padding: 8px;
        }
        
        .calendar-month-year {
            font-size: 0.95rem;
        }
        
        .calendar-header button {
            font-size: 1rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarContainer = document.getElementById('dashboard-calendar');
    
    if (!calendarContainer) return;
    
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth(); // 0-11
    
    const monthNames = [
        'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
        'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
    ];
    
    const dayNames = ['Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob', 'Nie'];
    
    let assignments = {};
    let notes = {};
    let duties = {}; // Duty assignments by date
    let currentSelectedDate = null;
    
    function renderCalendar(year, month) {
        // Clear container
        calendarContainer.innerHTML = '';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.innerHTML = `
            <button type="button" id="prev-month"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-month-year">${monthNames[month]} ${year}</span>
            <button type="button" id="next-month"><i class="fas fa-chevron-right"></i></button>
        `;
        calendarContainer.appendChild(header);
        
        // Create grid
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Add day headers
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });
        
        // Get first day of month (0 = Sunday, 1 = Monday, etc.)
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        // Adjust for Monday start (0 = Monday)
        const startDay = firstDay === 0 ? 6 : firstDay - 1;
        
        // Add previous month's days
        for (let i = startDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const dayDiv = createDayCell(day, true, false, year, month - 1);
            grid.appendChild(dayDiv);
        }
        
        // Add current month's days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = date.toDateString() === today.toDateString();
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const dayDiv = createDayCell(day, false, isToday, year, month, isWeekend);
            grid.appendChild(dayDiv);
        }
        
        // Fill remaining cells with next month's days
        const totalCells = grid.children.length - 7; // Subtract day headers
        const remainingCells = 42 - totalCells; // 6 weeks * 7 days
        for (let day = 1; day <= remainingCells; day++) {
            const dayDiv = createDayCell(day, true, false, year, month + 1);
            grid.appendChild(dayDiv);
        }
        
        calendarContainer.appendChild(grid);
        
        // Attach event listeners
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
            loadAssignments(currentYear, currentMonth + 1);
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
            loadAssignments(currentYear, currentMonth + 1);
        });
    }
    
    function createDayCell(day, isOtherMonth, isToday, year, month, isWeekend = false) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        if (isOtherMonth) {
            dayDiv.classList.add('other-month');
        } else {
            if (isToday) dayDiv.classList.add('today');
            if (isWeekend) dayDiv.classList.add('weekend');
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const hasAssignments = assignments[dateStr] && assignments[dateStr].length > 0;
            const hasNotes = notes[dateStr] && notes[dateStr].length > 0;
            const hasDuty = duties[dateStr]; // Check if there's a duty for this day
            
            // Make ALL days clickable, not just those with content
            dayDiv.dataset.date = dateStr;
            dayDiv.style.cursor = 'pointer';
            
            // Add duty badge if someone is on duty this day
            if (hasDuty) {
                const dutyBadge = document.createElement('span');
                dutyBadge.className = 'calendar-duty-badge';
                dutyBadge.textContent = hasDuty.initials;
                dutyBadge.title = `Dyżur: ${hasDuty.full_name}`;
                dutyBadge.style.cssText = 'position: absolute; top: 2px; left: 2px; background: #17a2b8; color: white; border-radius: 3px; padding: 2px 5px; font-size: 0.7rem; font-weight: bold;';
                dayDiv.appendChild(dutyBadge);
            }
            
            // Add visual indicators if there's content
            if (hasAssignments) {
                dayDiv.classList.add('has-assignments');
                const assignmentsBadge = document.createElement('span');
                assignmentsBadge.className = 'calendar-day-badge assignments-badge';
                assignmentsBadge.textContent = assignments[dateStr].length;
                dayDiv.appendChild(assignmentsBadge);
            }
            
            if (hasNotes) {
                dayDiv.classList.add('has-notes');
                const notesBadge = document.createElement('span');
                notesBadge.className = 'calendar-day-badge notes-badge';
                notesBadge.textContent = notes[dateStr].length;
                dayDiv.appendChild(notesBadge);
            }
            
            // Add click handler to show modal for ALL days
            dayDiv.addEventListener('click', () => {
                showDayDetails(dateStr);
            });
            
            // Build tooltip only if there's content
            if (hasAssignments || hasNotes || hasDuty) {
                let tooltipParts = [];
                if (hasDuty) {
                    tooltipParts.push(`🔵 Dyżur: ${hasDuty.full_name}`);
                }
                if (hasAssignments) {
                    const ticketInfo = assignments[dateStr].map(a => {
                        let info = `• ${a.ticket_title}`;
                        if (a.notes && a.notes.trim()) {
                            info += `\n  ↳ ${a.notes}`;
                        }
                        return info;
                    }).join('\n');
                    tooltipParts.push(`Zgłoszenia (${assignments[dateStr].length}):\n${ticketInfo}`);
                }
                if (hasNotes) {
                    const notesInfo = notes[dateStr].map(n => `• ${n.title}`).join('\n');
                    tooltipParts.push(`Notatki (${notes[dateStr].length}):\n${notesInfo}`);
                }
                dayDiv.title = tooltipParts.join('\n\n');
            } else {
                dayDiv.title = 'Kliknij aby dodać notatkę';
            }
        }
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        dayDiv.appendChild(dayNumber);
        
        return dayDiv;
    }
    
    function loadAssignments(year, month) {
        // Load both assignments and notes
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const startDate = firstDay.toISOString().split('T')[0];
        const endDate = lastDay.toISOString().split('T')[0];
        
        // Load assignments
        fetch(`/calendar/assignments/?year=${year}&month=${month}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                assignments = data.assignments;
                duties = data.duties || {}; // Store duties information
            }
            // Load notes
            return fetch(`/api/calendar-notes/?start=${startDate}&end=${endDate}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Group notes by date
                notes = {};
                data.notes.forEach(note => {
                    if (!notes[note.date]) {
                        notes[note.date] = [];
                    }
                    notes[note.date].push(note);
                });
            }
            renderCalendar(currentYear, currentMonth);
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
        });
    }
    
    // Functions for day details modal
    function showDayDetails(dateStr) {
        currentSelectedDate = dateStr;
        const modal = new bootstrap.Modal(document.getElementById('calendarNoteModal'));
        
        // Format date for display
        const [year, month, day] = dateStr.split('-');
        const date = new Date(year, month - 1, day);
        const dateFormatted = date.toLocaleDateString('pl-PL', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        document.getElementById('noteModalDate').textContent = dateFormatted;
        
        // Show duty section if superagent/admin and there's a duty
        {% if user.profile.role in 'admin,superagent' %}
        const dutySection = document.getElementById('dutySection');
        const dutyInfo = document.getElementById('dutyInfo');
        
        if (duties[dateStr]) {
            dutySection.style.display = 'block';
            dutyInfo.innerHTML = `
                <strong><i class="fas fa-user me-1"></i>${duties[dateStr].full_name}</strong> (${duties[dateStr].username}) pełni dyżur tego dnia
                ${duties[dateStr].notes ? `<br><small class="text-muted"><i class="fas fa-info-circle me-1"></i>${escapeHtml(duties[dateStr].notes)}</small>` : ''}
            `;
        } else {
            dutySection.style.display = 'block';
            dutyInfo.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Brak przypisanego dyżuru na ten dzień.';
        }
        {% endif %}
        
        // Show assignments section if any
        const assignmentsSection = document.getElementById('assignmentsSection');
        const assignmentsList = document.getElementById('assignmentsList');
        
        if (assignments[dateStr] && assignments[dateStr].length > 0) {
            assignmentsSection.style.display = 'block';
            assignmentsList.innerHTML = assignments[dateStr].map(a => `
                <div class="card mb-2 border-success">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">
                            <a href="/tickets/${a.ticket_id}/" class="text-decoration-none">
                                <i class="fas fa-ticket-alt me-1"></i>#${a.ticket_id} - ${escapeHtml(a.ticket_title)}
                            </a>
                        </h6>
                        <span class="badge bg-${a.ticket_priority === 'high' ? 'danger' : a.ticket_priority === 'medium' ? 'warning' : 'secondary'} me-1">
                            ${a.ticket_priority === 'high' ? 'Wysoki' : a.ticket_priority === 'medium' ? 'Średni' : 'Niski'}
                        </span>
                        ${a.notes ? `
                        <div class="mt-2 p-2 bg-light rounded">
                            <small class="text-muted d-block mb-1"><i class="fas fa-sticky-note me-1"></i><strong>Notatki z przypisania:</strong></small>
                            <small class="text-dark">${escapeHtml(a.notes)}</small>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        } else {
            assignmentsSection.style.display = 'none';
        }
        
        // Show notes
        refreshNotesList();
        
        modal.show();
    }
    
    function refreshNotesList() {
        const notesList = document.getElementById('notesList');
        
        if (!currentSelectedDate || !notes[currentSelectedDate] || notes[currentSelectedDate].length === 0) {
            notesList.innerHTML = '<p class="text-muted small">Brak notatek na ten dzień.</p>';
            return;
        }
        
        notesList.innerHTML = notes[currentSelectedDate].map(note => {
            const isOwn = note.is_own !== false; // Default to true for backwards compatibility
            const privacyIcon = note.is_private ? '<i class="fas fa-lock text-warning me-1" title="Notatka prywatna"></i>' : '<i class="fas fa-users text-success me-1" title="Notatka publiczna"></i>';
            const authorInfo = !isOwn && note.author ? `<small class="text-muted d-block">Autor: ${escapeHtml(note.author)}</small>` : '';
            
            return `
            <div class="card mb-2 ${isOwn ? 'border-info' : 'border-secondary'}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">
                                ${privacyIcon}${escapeHtml(note.title)}
                            </h6>
                            ${note.content ? `<p class="card-text small mb-0">${escapeHtml(note.content)}</p>` : ''}
                            ${authorInfo}
                            <small class="text-muted">Zaktualizowano: ${new Date(note.updated_at).toLocaleString('pl-PL')}</small>
                        </div>
                        ${isOwn ? `
                        <div class="btn-group-vertical btn-group-sm ms-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="editNote(${note.id})" title="Edytuj">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote(${note.id})" title="Usuń">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }
    
    function showAddNoteForm() {
        document.getElementById('addNoteForm').style.display = 'block';
        document.getElementById('addNoteBtn').style.display = 'none';
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteContent').value = '';
        document.getElementById('noteIsPrivate').checked = true; // Default to private
        document.getElementById('noteTitle').focus();
    }
    
    function cancelNoteForm() {
        document.getElementById('addNoteForm').style.display = 'none';
        document.getElementById('addNoteBtn').style.display = 'block';
    }
    
    function saveNote() {
        const title = document.getElementById('noteTitle').value.trim();
        const content = document.getElementById('noteContent').value.trim();
        const isPrivate = document.getElementById('noteIsPrivate').checked;
        
        if (!title) {
            alert('Tytuł jest wymagany');
            return;
        }
        
        fetch('/api/calendar-notes/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                date: currentSelectedDate,
                title: title,
                content: content,
                is_private: isPrivate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add note to local data
                if (!notes[currentSelectedDate]) {
                    notes[currentSelectedDate] = [];
                }
                notes[currentSelectedDate].push(data.note);
                
                refreshNotesList();
                cancelNoteForm();
                renderCalendar(currentYear, currentMonth);
            } else {
                alert('Błąd: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving note:', error);
            alert('Wystąpił błąd podczas zapisywania notatki');
        });
    }
    
    function editNote(noteId) {
        const note = notes[currentSelectedDate].find(n => n.id === noteId);
        if (!note) return;
        
        document.getElementById('editNoteId').value = noteId;
        document.getElementById('editNoteTitle').value = note.title;
        document.getElementById('editNoteContent').value = note.content || '';
        document.getElementById('editNoteIsPrivate').checked = note.is_private;
        document.getElementById('editNoteForm').style.display = 'block';
        document.getElementById('addNoteBtn').style.display = 'none';
        document.getElementById('editNoteTitle').focus();
    }
    
    function cancelEditForm() {
        document.getElementById('editNoteForm').style.display = 'none';
        document.getElementById('addNoteBtn').style.display = 'block';
    }
    
    function updateNote() {
        const noteId = document.getElementById('editNoteId').value;
        const title = document.getElementById('editNoteTitle').value.trim();
        const content = document.getElementById('editNoteContent').value.trim();
        const isPrivate = document.getElementById('editNoteIsPrivate').checked;
        
        if (!title) {
            alert('Tytuł jest wymagany');
            return;
        }
        
        fetch(`/api/calendar-notes/${noteId}/update/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                content: content,
                is_private: isPrivate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update note in local data
                const noteIndex = notes[currentSelectedDate].findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    notes[currentSelectedDate][noteIndex] = data.note;
                }
                
                refreshNotesList();
                cancelEditForm();
                renderCalendar(currentYear, currentMonth);
            } else {
                alert('Błąd: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating note:', error);
            alert('Wystąpił błąd podczas aktualizacji notatki');
        });
    }
    
    function deleteNote(noteId) {
        if (!confirm('Czy na pewno chcesz usunąć tę notatkę?')) {
            return;
        }
        
        fetch(`/api/calendar-notes/${noteId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove note from local data
                notes[currentSelectedDate] = notes[currentSelectedDate].filter(n => n.id !== noteId);
                
                refreshNotesList();
                renderCalendar(currentYear, currentMonth);
            } else {
                alert('Błąd: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting note:', error);
            alert('Wystąpił błąd podczas usuwania notatki');
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    {% if user.profile.role in 'admin,superagent' %}
    // Function to change duty for a specific day
    function changeDuty() {
        if (!currentSelectedDate) return;
        
        // Show prompt with available users
        const currentDuty = duties[currentSelectedDate];
        const message = currentDuty 
            ? `Obecnie dyżur pełni: ${currentDuty.full_name}\n\nWybierz nową osobę dyżurującą:` 
            : 'Wybierz osobę dyżurującą na ten dzień:';
        
        // In a real implementation, this should be a proper modal with a select dropdown
        // For now, we'll use a simple prompt
        const newUserInput = prompt(message + '\n\nWpisz ID użytkownika (dostępni użytkownicy zostaną wyświetleni w przyszłej wersji):');
        
        if (!newUserInput) return;
        
        // Send AJAX request to change duty
        fetch('/calendar/change-duty/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `duty_date=${currentSelectedDate}&user_id=${newUserInput}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Reload calendar data
                loadAssignments(currentYear, currentMonth + 1);
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('calendarNoteModal')).hide();
            } else {
                alert('Błąd: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error changing duty:', error);
            alert('Wystąpił błąd podczas zmiany dyżuru');
        });
    }
    
    // Make changeDuty globally accessible
    window.changeDuty = changeDuty;
    {% endif %}
    
    // Make functions globally accessible
    window.showAddNoteForm = showAddNoteForm;
    window.cancelNoteForm = cancelNoteForm;
    window.saveNote = saveNote;
    window.editNote = editNote;
    window.cancelEditForm = cancelEditForm;
    window.updateNote = updateNote;
    window.deleteNote = deleteNote;
    
    // Initial render
    renderCalendar(currentYear, currentMonth);
    loadAssignments(currentYear, currentMonth + 1);
});
</script>
{% endif %}
{% endblock %}
