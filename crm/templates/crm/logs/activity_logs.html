{% extends 'crm/base.html' %}

{% block title %}Logi aktywności | System Helpdesk{% endblock %}

{% block extra_css %}
<style>
    .logs-table th, .logs-table td {
        font-size: 0.9rem;
        padding: 0.5rem;
    }
    .truncate-text {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
    }
    .col-datetime { width: 15%; }
    .col-user { width: 12%; }
    .col-action { width: 12%; }
    .col-ticket { width: 10%; }
    .col-details { width: 23%; }
    .col-ip { width: 15%; }
    .col-actions { width: 8%; }
    
    /* Mobile responsive styles */
    @media (max-width: 576px) {
        .logs-header-desktop {
            display: none !important;
        }
        
        .logs-header-mobile {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .logs-header-mobile h2 {
            font-size: 1.5rem;
            margin: 0;
            flex: 1;
        }
        
        .logs-header-mobile .btn-group {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .logs-header-mobile .btn {
            padding: 8px 12px;
            font-size: 0.875rem;
        }
        
        .desktop-table {
            display: none !important;
        }
        
        .mobile-cards {
            display: block !important;
        }
        
        .mobile-log-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mobile-log-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .mobile-log-datetime {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .mobile-log-action {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            color: #495057;
            white-space: nowrap;
        }
        
        .mobile-log-field {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            min-height: 24px;
        }
        
        .mobile-log-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.85rem;
            margin-right: 10px;
            min-width: 70px;
            flex-shrink: 0;
        }
        
        .mobile-log-value {
            color: #495057;
            font-size: 0.85rem;
            text-align: right;
            flex: 1;
            word-break: break-word;
        }
        
        .mobile-log-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
        
        .mobile-log-btn {
            width: 100%;
            padding: 10px;
            font-size: 14px;
        }
        
        /* Action type specific colors */
        .action-login { background-color: #d4edda; color: #155724; }
        .action-logout { background-color: #f8d7da; color: #721c24; }
        .action-failed { background-color: #fff3cd; color: #856404; }
        .action-error { background-color: #f5c6cb; color: #721c24; }
        .action-ticket { background-color: #d1ecf1; color: #0c5460; }
        .action-admin { background-color: #e2e3e5; color: #383d41; }
    }
    
    /* Desktop styles */
    @media (min-width: 577px) {
        .logs-header-mobile {
            display: none !important;
        }
        
        .logs-header-desktop {
            display: flex !important;
        }
        
        .desktop-table {
            display: block !important;
        }
        
        .mobile-cards {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Desktop Header -->
<div class="d-flex justify-content-between align-items-center mb-4 logs-header-desktop">
    <h2>Logi aktywności</h2>
    <div>
        {% if user.profile.role == 'admin' %}
        <a href="{% url 'activity_logs_wipe' %}" class="btn btn-danger btn-ripple">
            <i class="fas fa-trash-alt"></i> Wyczyść wszystkie logi
        </a>
        {% endif %}
    </div>
</div>

<!-- Mobile Header -->
<div class="logs-header-mobile mb-4">
    <h2>Logi aktywności</h2>
    <div class="btn-group">
        {% if user.profile.role == 'admin' %}
        <a href="{% url 'activity_logs_wipe' %}" class="btn btn-danger btn-sm">
            <i class="fas fa-trash-alt"></i>
        </a>
        {% endif %}
    </div>
</div>

<!-- Filtry -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-filter me-2"></i> Filtry
    </div>
    <div class="card-body">
        <form method="get">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="action" class="form-label">Akcja:</label>
                    <select name="action" id="action" class="form-select form-select-sm">
                        <option value="" {% if not action_filter %}selected{% endif %}>Wszystkie</option>
                        <option value="login" {% if action_filter == 'login' %}selected{% endif %}>Zalogowanie</option>
                        <option value="logout" {% if action_filter == 'logout' %}selected{% endif %}>Wylogowanie</option>
                        <option value="login_failed" {% if action_filter == 'login_failed' %}selected{% endif %}>Nieudane logowanie</option>
                        <option value="account_locked" {% if action_filter == 'account_locked' %}selected{% endif %}>Blokada konta</option>
                        <option value="account_unlocked" {% if action_filter == 'account_unlocked' %}selected{% endif %}>Odblokowanie konta</option>
                        <option value="ticket_created" {% if action_filter == 'ticket_created' %}selected{% endif %}>Utworzenie zgłoszenia</option>
                        <option value="ticket_updated" {% if action_filter == 'ticket_updated' %}selected{% endif %}>Aktualizacja zgłoszenia</option>
                        <option value="ticket_commented" {% if action_filter == 'ticket_commented' %}selected{% endif %}>Odpowiedź do zgłoszenia</option>
                        <option value="ticket_resolved" {% if action_filter == 'ticket_resolved' %}selected{% endif %}>Rozwiązanie zgłoszenia</option>
                        <option value="ticket_closed" {% if action_filter == 'ticket_closed' %}selected{% endif %}>Zamknięcie zgłoszenia</option>
                        <option value="ticket_reopened" {% if action_filter == 'ticket_reopened' %}selected{% endif %}>Ponowne otwarcie zgłoszenia</option>
                        <option value="preferences_updated" {% if action_filter == 'preferences_updated' %}selected{% endif %}>Aktualizacja preferencji</option>
                        <option value="404_error" {% if action_filter == '404_error' %}selected{% endif %}>Błąd 404 - Strona nie znaleziona</option>
                        <option value="403_error" {% if action_filter == '403_error' %}selected{% endif %}>Błąd 403 - Brak dostępu</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="user" class="form-label">Użytkownik:</label>
                    <input type="text" name="user" id="user" class="form-control form-control-sm" value="{{ user_filter|default:'' }}" placeholder="Nazwa użytkownika">
                </div>
                <div class="col-md-2">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-sm btn-primary btn-ripple">
                            <i class="fas fa-search me-1"></i> Zastosuj
                        </button>
                        <a href="{% url 'activity_logs' %}" class="btn btn-sm btn-outline-secondary btn-ripple">
                            <i class="fas fa-sync-alt me-1"></i> Resetuj
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Lista logów -->
{% if logs %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-history"></i> Lista logów
    </div>
    <div class="card-body">
        <!-- Desktop Table View -->
        <div class="desktop-table">
            <div class="table-responsive">
                <table class="table table-hover logs-table">
                    <thead>
                        <tr>
                            <th class="col-datetime">Data i czas</th>
                            <th class="col-user">Użytkownik</th>
                            <th class="col-action">Akcja</th>
                            <th class="col-ticket">Zgłoszenie</th>
                            <th class="col-details">Szczegóły</th>
                            <th class="col-ip">Adres IP</th>
                            <th class="col-actions">Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.created_at|date:"d.m.Y H:i:s" }}</td>
                            <td>
                                {% if log.user %}
                                    {{ log.user.username }}
                                    {% if log.user.profile.role == 'admin' %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% elif log.user.profile.role == 'superagent' %}
                                        <span class="badge bg-warning text-dark">Superagent</span>
                                    {% elif log.user.profile.role == 'agent' %}
                                        <span class="badge bg-info">Agent</span>
                                    {% elif log.user.profile.role == 'viewer' %}
                                        <span class="badge bg-dark">Viewer</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Klient</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Anonimowy</span>
                                    {% if log.action_type == 'login_failed' %}
                                        <span class="badge bg-warning text-dark">Nieudane logowanie</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ log.get_action_type_display }}</td>
                            <td>
                                {% if log.ticket %}
                                <a href="{% url 'ticket_detail' log.ticket.pk %}">#{{ log.ticket.id }}</a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if log.description %}
                                <span class="truncate-text" title="{{ log.description }}">{{ log.description }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ log.ip_address|default:"-" }}</td>
                            <td>
                                <a href="{% url 'activity_log_detail' log.id %}" class="btn btn-sm btn-info btn-ripple">
                                    <i class="fas fa-search"></i> Szczegóły
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Mobile Card View -->
        <div class="mobile-cards">
            {% for log in logs %}
            <div class="mobile-log-card">
                <div class="mobile-log-header">
                    <span class="mobile-log-datetime">{{ log.created_at|date:"d.m.Y H:i:s" }}</span>
                    <span class="mobile-log-action {% if 'login' in log.action_type %}action-login{% elif 'logout' in log.action_type %}action-logout{% elif 'failed' in log.action_type %}action-failed{% elif 'error' in log.action_type %}action-error{% elif 'ticket' in log.action_type %}action-ticket{% else %}action-admin{% endif %}">
                        {{ log.get_action_type_display }}
                    </span>
                </div>
                
                <div class="mobile-log-field">
                    <span class="mobile-log-label">Użytkownik:</span>
                    <div class="mobile-log-value">
                        {% if log.user %}
                            <div>{{ log.user.username }}</div>
                            {% if log.user.profile.role == 'admin' %}
                                <span class="badge bg-danger">Admin</span>
                            {% elif log.user.profile.role == 'superagent' %}
                                <span class="badge bg-warning text-dark">Superagent</span>
                            {% elif log.user.profile.role == 'agent' %}
                                <span class="badge bg-info">Agent</span>
                            {% elif log.user.profile.role == 'viewer' %}
                                <span class="badge bg-dark">Viewer</span>
                            {% else %}
                                <span class="badge bg-secondary">Klient</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Anonimowy</span>
                            {% if log.action_type == 'login_failed' %}
                                <span class="badge bg-warning text-dark">Nieudane</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                {% if log.ticket %}
                <div class="mobile-log-field">
                    <span class="mobile-log-label">Zgłoszenie:</span>
                    <span class="mobile-log-value">
                        <a href="{% url 'ticket_detail' log.ticket.pk %}">#{{ log.ticket.id }}</a>
                    </span>
                </div>
                {% endif %}
                
                {% if log.description %}
                <div class="mobile-log-field">
                    <span class="mobile-log-label">Szczegóły:</span>
                    <span class="mobile-log-value">{{ log.description }}</span>
                </div>
                {% endif %}
                
                <div class="mobile-log-field">
                    <span class="mobile-log-label">IP:</span>
                    <span class="mobile-log-value">{{ log.ip_address|default:"-" }}</span>
                </div>
                
                <div class="mobile-log-actions">
                    <a href="{% url 'activity_log_detail' log.id %}" class="btn btn-info mobile-log-btn">
                        <i class="fas fa-search"></i> Szczegóły
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <p>Nie znaleziono logów spełniających wybrane kryteria.</p>
</div>
{% endif %}
{% endblock %}
