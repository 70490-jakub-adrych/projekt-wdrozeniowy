{% extends 'crm/base.html' %}

{% block title %}Symulacja perspektywy użytkownika{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-user-secret"></i>
                        Symulacja perspektywy użytkownika
                    </h4>
                    <small class="text-muted">Funkcja testowa dla administratorów</small>
                </div>
                <div class="card-body">
                    {% if current_impersonation %}
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> Aktualnie symulowany użytkownik</h5>
                            <p>Przeglądasz system z perspektywy innego użytkownika. Wszystkie uprawnienia i widoki są ograniczone do roli tego użytkownika.</p>
                            
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="user_id" value="reset">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-undo"></i> Powróć do widoku administratora
                                </button>
                            </form>
                        </div>
                    {% endif %}

                    <form method="post" id="impersonation-form">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="user_select">Wybierz użytkownika do symulacji:</label>
                            <select name="user_id" id="user_select" class="form-control" required>
                                <option value="">-- Wybierz użytkownika --</option>
                                {% regroup users by profile.role as users_by_role %}
                                {% for role_group in users_by_role %}
                                    <optgroup label="{{ role_group.grouper|title }}">
                                        {% for user in role_group.list %}
                                            <option value="{{ user.id }}" 
                                                    data-role="{{ user.profile.role }}"
                                                    {% if current_impersonation == user.id %}selected{% endif %}>
                                                {% if user.get_full_name %}
                                                    {{ user.get_full_name }} ({{ user.username }})
                                                {% else %}
                                                    {{ user.username }}
                                                {% endif %}
                                                - {{ user.profile.get_role_display }}
                                                {% if user.profile.organizations.exists %}
                                                    - {{ user.profile.organizations.first.name }}
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group" id="organization-group">
                            <label for="organization_select">Symulacja dostępu do organizacji:</label>
                            <select name="organization_ids" id="organization_select" class="form-control" multiple>
                                {% for org in organizations %}
                                    <option value="{{ org.id }}" 
                                            {% if org.id in current_organizations %}selected{% endif %}>
                                        {{ org.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Wybierz organizacje, do których ma mieć dostęp symulowany użytkownik. 
                                Pozostaw puste aby symulować brak dostępu do organizacji.
                                <span id="client-warning" class="text-warning" style="display: none;">
                                    <br><strong>Uwaga:</strong> Klienci mogą być przypisani tylko do jednej organizacji.
                                </span>
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-eye"></i> Przełącz perspektywę
                            </button>
                            
                            {% if current_impersonation %}
                                <button type="submit" name="user_id" value="reset" class="btn btn-secondary ml-2">
                                    <i class="fas fa-undo"></i> Zakończ symulację
                                </button>
                            {% endif %}
                        </div>
                    </form>

                    <div class="mt-4">
                        <h5>Informacje o funkcji</h5>
                        <ul class="text-muted">
                            <li>Ta funkcja pozwala administratorom testować system z perspektywy innych użytkowników</li>
                            <li>Wszystkie uprawnienia i ograniczenia są stosowane zgodnie z rolą symulowanego użytkownika</li>
                            <li>Można również symulować dostęp do określonych organizacji, niezależnie od rzeczywistych przypisań</li>
                            <li>Klienci mogą być przypisani tylko do jednej organizacji (ograniczenie frontendowe)</li>
                            <li>Działania wykonane podczas symulacji są logowane jako wykonane przez administratora</li>
                            <li>W stopce strony pojawi się ostrzeżenie o aktywnej symulacji</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Add search functionality to user select
    $('#user_select').select2({
        placeholder: "Wyszukaj użytkownika...",
        allowClear: true,
        width: '100%'
    });
    
    // Add search functionality to organization select
    $('#organization_select').select2({
        placeholder: "Wybierz organizacje...",
        allowClear: true,
        width: '100%'
    });
    
    // Handle client role restrictions
    function handleRoleChange() {
        var selectedOption = $('#user_select option:selected');
        var role = selectedOption.data('role');
        var $orgGroup = $('#organization-group');
        var $orgSelect = $('#organization_select');
        var $clientWarning = $('#client-warning');
        
        if (role === 'client') {
            // Limit to single selection for clients
            $orgSelect.attr('multiple', false);
            $orgSelect.select2('destroy').select2({
                placeholder: "Wybierz organizację...",
                allowClear: true,
                width: '100%',
                maximumSelectionLength: 1
            });
            $clientWarning.show();
            
            // If more than one organization is selected, keep only the first one
            var selected = $orgSelect.val();
            if (Array.isArray(selected) && selected.length > 1) {
                $orgSelect.val([selected[0]]).trigger('change');
            }
        } else {
            // Allow multiple selections for non-clients
            $orgSelect.attr('multiple', true);
            $orgSelect.select2('destroy').select2({
                placeholder: "Wybierz organizacje...",
                allowClear: true,
                width: '100%'
            });
            $clientWarning.hide();
        }
        
        // Show/hide organization group based on selection
        if (selectedOption.val()) {
            $orgGroup.show();
        } else {
            $orgGroup.hide();
        }
    }
    
    // Initial setup
    handleRoleChange();
    
    // Handle user selection change
    $('#user_select').on('change', handleRoleChange);
    
    // Form validation
    $('#impersonation-form').on('submit', function(e) {
        var selectedUser = $('#user_select').val();
        if (!selectedUser) {
            e.preventDefault();
            alert('Proszę wybrać użytkownika do symulacji.');
            return false;
        }
        
        var selectedOption = $('#user_select option:selected');
        var role = selectedOption.data('role');
        var selectedOrgs = $('#organization_select').val();
        
        if (role === 'client' && selectedOrgs && selectedOrgs.length > 1) {
            e.preventDefault();
            alert('Klienci mogą być przypisani tylko do jednej organizacji.');
            return false;
        }
    });
});
</script>
{% endblock %}
