{% extends 'crm/base.html' %}

{% block title %}Zgłoszenia | System Helpdesk{% endblock %}

{% block extra_css %}
<style>
    .action-btn {
        width: 36px;
        height: 36px;
        padding: 6px 0;
        text-align: center;
        margin-right: 2px;
    }
    
    .btn-group .action-btn:last-child {
        margin-right: 0;
    }
    
    .btn-group {
        display: flex;
        justify-content: flex-start;
    }
    
    .filter-row {
        margin-bottom: 10px;
    }
    
    .filter-label {
        font-weight: bold;
        min-width: 80px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Debug section for staff only -->
{% if user.is_staff %}
<div class="card mb-4 bg-light">
    <div class="card-header bg-warning">
        <i class="fas fa-bug"></i> Debug Information (Staff Only)
    </div>
    <div class="card-body">
        <p><strong>Username:</strong> {{ user.username }}, <strong>Role:</strong> {{ user.profile.role }}</p>
        <p><strong>Organizations:</strong> 
            {% for org in user_organizations %}
                {{ org.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
                None
            {% endfor %}
        </p>
        <p><strong>Found {{ tickets.count }} tickets</strong> with current filters</p>
        <a href="{% url 'debug_tickets' %}" target="_blank" class="btn btn-sm btn-warning">
            <i class="fas fa-bug"></i> Detailed Debug Info
        </a>
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Zgłoszenia</h2>
    <a href="{% url 'ticket_create' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nowe zgłoszenie
    </a>
</div>

<!-- Filtry -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-filter"></i> Filtry
    </div>
    <div class="card-body">
        <form method="get" class="form-inline">
            <div class="container-fluid p-0">
                <div class="row filter-row">
                    <div class="col-md-3">
                        <label for="status" class="filter-label">Status:</label>
                        <select name="status" id="status" class="form-control form-control-sm">
                            <option value="" {% if not status_filter %}selected{% endif %}>Wszystkie</option>
                            <option value="new" {% if status_filter == 'new' %}selected{% endif %}>Nowe</option>
                            <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>W trakcie</option>
                            <option value="waiting" {% if status_filter == 'waiting' %}selected{% endif %}>Oczekujące</option>
                            <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Rozwiązane</option>
                            <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Zamknięte</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="priority" class="filter-label">Priorytet:</label>
                        <select name="priority" id="priority" class="form-control form-control-sm">
                            <option value="" {% if not priority_filter %}selected{% endif %}>Wszystkie</option>
                            <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Niski</option>
                            <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Średni</option>
                            <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>Wysoki</option>
                            <option value="critical" {% if priority_filter == 'critical' %}selected{% endif %}>Krytyczny</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="category" class="filter-label">Kategoria:</label>
                        <select name="category" id="category" class="form-control form-control-sm">
                            <option value="" {% if not category_filter %}selected{% endif %}>Wszystkie</option>
                            <option value="hardware" {% if category_filter == 'hardware' %}selected{% endif %}>Sprzęt</option>
                            <option value="software" {% if category_filter == 'software' %}selected{% endif %}>Oprogramowanie</option>
                            <option value="network" {% if category_filter == 'network' %}selected{% endif %}>Sieć</option>
                            <option value="account" {% if category_filter == 'account' %}selected{% endif %}>Konto</option>
                            <option value="other" {% if category_filter == 'other' %}selected{% endif %}>Inne</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="assigned" class="filter-label">Przypisane:</label>
                        <select name="assigned" id="assigned" class="form-control form-control-sm">
                            <option value="" {% if not assigned_filter %}selected{% endif %}>Wszystkie</option>
                            <option value="me" {% if assigned_filter == 'me' %}selected{% endif %}>Do mnie</option>
                            <option value="unassigned" {% if assigned_filter == 'unassigned' %}selected{% endif %}>Nieprzypisane</option>
                        </select>
                    </div>
                </div>
                
                <!-- Additional filters for client-specific views -->
                {% if user.profile.role == 'client' %}
                <div class="row filter-row">
                    <div class="col-md-3">
                        <label for="created_by" class="filter-label">Utworzone przez:</label>
                        <select name="created_by" id="created_by" class="form-control form-control-sm">
                            <option value="" {% if not created_by_filter %}selected{% endif %}>Wszystkie</option>
                            <option value="me" {% if created_by_filter == 'me' %}selected{% endif %}>Moje zgłoszenia</option>
                            <option value="" data-exclude="me" {% if exclude_created_by == 'me' %}selected{% endif %}>Zgłoszenia innych</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <!-- Empty space to align with other rows -->
                    </div>
                </div>
                {% endif %}
                
                <div class="row filter-row">
                    <div class="col-md-3">
                        <label for="ticket_id" class="filter-label">ID zgłoszenia:</label>
                        <input type="number" name="ticket_id" id="ticket_id" class="form-control form-control-sm" value="{{ ticket_id }}" placeholder="np. 123">
                    </div>
                    <div class="col-md-3">
                        <label for="date_from" class="filter-label">Data od:</label>
                        <input type="date" name="date_from" id="date_from" class="form-control form-control-sm" value="{{ date_from }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="filter-label">Data do:</label>
                        <input type="date" name="date_to" id="date_to" class="form-control form-control-sm" value="{{ date_to }}">
                    </div>
                    <div class="col-md-3">
                        <label for="sort_by" class="filter-label">Sortowanie:</label>
                        <select name="sort_by" id="sort_by" class="form-control form-control-sm">
                            {% for sort_value, sort_label in sort_options %}
                                <option value="{{ sort_value }}" {% if sort_by == sort_value %}selected{% endif %}>{{ sort_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Add hidden input for exclude_created_by when needed -->
                {% if exclude_created_by %}
                <input type="hidden" name="exclude_created_by" value="{{ exclude_created_by }}">
                {% endif %}
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <!-- Use a checkbox without a name attribute so it's not submitted directly -->
                            <input class="form-check-input" type="checkbox" id="exclude_closed_checkbox" {% if exclude_closed %}checked{% endif %}>
                            <label class="form-check-label" for="exclude_closed_checkbox">
                                Pokaż tylko niezamknięte zgłoszenia
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6 text-right">
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-search"></i> Zastosuj filtry
                        </button>
                        <a href="{% url 'ticket_list' %}" class="btn btn-sm btn-outline-secondary ml-2">
                            <i class="fas fa-sync"></i> Resetuj
                        </a>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- JavaScript to ensure exclude_closed is always added to the form -->
        <script>
            document.querySelector('form').addEventListener('submit', function() {
                // Add hidden input with current checkbox state before submission
                var isChecked = document.getElementById('exclude_closed_checkbox').checked;
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'exclude_closed';
                input.value = isChecked ? 'true' : 'false';
                this.appendChild(input);
            });
        </script>
    </div>
</div>

<!-- Lista zgłoszeń -->
{% if tickets %}
<div class="card">
    <div class="card-header">
        <i class="fas fa-ticket-alt"></i> Lista zgłoszeń
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tytuł</th>
                        <th>Organizacja</th>
                        <th>Kategoria</th>
                        <th>Priorytet</th>
                        <th>Status</th>
                        <th>Przypisane do</th>
                        <th>Data utworzenia</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ticket in tickets %}
                    <tr>
                        <td>#{{ ticket.id }}</td>
                        <td><a href="{% url 'ticket_detail' ticket.pk %}">{{ ticket.title }}</a></td>
                        <td>{{ ticket.organization.name }}</td>
                        <td>{{ ticket.get_category_display }}</td>
                        <td>
                            <span class="badge 
                                {% if ticket.priority == 'low' %}badge-secondary
                                {% elif ticket.priority == 'medium' %}badge-info
                                {% elif ticket.priority == 'high' %}badge-warning
                                {% elif ticket.priority == 'critical' %}badge-danger
                                {% endif %}">
                                {{ ticket.get_priority_display }}
                            </span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if ticket.status == 'new' %}badge-primary
                                {% elif ticket.status == 'in_progress' %}badge-info
                                {% elif ticket.status == 'waiting' %}badge-warning
                                {% elif ticket.status == 'resolved' %}badge-success
                                {% elif ticket.status == 'closed' %}badge-secondary
                                {% endif %}">
                                {{ ticket.get_status_display }}
                            </span>
                        </td>
                        <td>{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}
                            <span class="text-muted">Nieprzypisane</span>
                            {% if user.profile.role == 'agent' %}
                            <a href="{% url 'ticket_assign_to_me' ticket.pk %}" class="btn btn-sm btn-outline-info ml-2">
                                <i class="fas fa-user-check"></i>
                            </a>
                            {% endif %}
                        {% endif %}</td>
                        <td>{{ ticket.created_at|date:"d.m.Y H:i" }}</td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'ticket_detail' ticket.pk %}" class="btn btn-sm btn-info action-btn" title="Szczegóły">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if user.profile.role in 'admin,agent' or ticket.created_by == user %}
                                <a href="{% url 'ticket_update' ticket.pk %}" class="btn btn-sm btn-primary action-btn" title="Edytuj">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% endif %}
                                
                                <!-- Only show close/reopen buttons for admins and agents -->
                                {% if user.profile.role in 'admin,agent' %}
                                    {% if ticket.status != 'closed' and ticket.assigned_to %}
                                    <a href="{% url 'ticket_close' ticket.pk %}" class="btn btn-sm btn-secondary action-btn" title="Zamknij">
                                        <i class="fas fa-lock"></i>
                                    </a>
                                    {% elif ticket.status == 'closed' %}
                                    <a href="{% url 'ticket_reopen' ticket.pk %}" class="btn btn-sm btn-success action-btn" title="Otwórz ponownie">
                                        <i class="fas fa-lock-open"></i>
                                    </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <p>Nie znaleziono zgłoszeń spełniających wybrane kryteria.</p>
</div>
{% endif %}
{% endblock %}
