{% extends 'crm/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Statystyki | System Helpdesk{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .data-table {
        font-size: 0.85rem;  /* Smaller font */
    }
    /* More compact filter elements */
    .filter-section {
        background-color: #f8f9fa;
        padding: 12px;  /* Reduced padding */
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .filter-section label {
        font-size: 0.85rem;
        margin-bottom: 0.2rem;
    }
    .filter-section .form-control {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }
    /* Card headers with less padding */
    .card-header {
        padding: 0.75rem 1rem;
    }
    /* Compact stats row */
    .stat-card-label {
        font-size: 0.85rem;
        white-space: nowrap;
    }
    .performance-indicator {
        font-weight: bold;
    }
    .performance-good {
        color: #28a745;
    }
    .performance-medium {
        color: #ffc107;
    }
    .performance-poor {
        color: #dc3545;
    }
    
    /* Mobile filter styles */
    .mobile-filter-controls {
        display: none;
    }
    
    .desktop-filter-card {
        display: block;
    }
    
    @media (max-width: 576px) {
        .mobile-filter-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .desktop-filter-card {
            display: none;
        }
        
        .mobile-filter-modal .modal-dialog {
            margin: 0;
        }
    }
    
    /* Statistics header for mobile */
    .stats-header-mobile {
        display: none;
    }
    
    .stats-header-desktop {
        display: block;
    }
    
    @media (max-width: 576px) {
        .stats-header-mobile {
            display: block;
        }
        
        .stats-header-desktop {
            display: none;
        }
    }
    
    /* Smooth animation for agent tickets expandable rows */
    .agent-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .agent-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .agent-tickets-row td {
        padding: 0 !important;
        border: none !important;
    }
    
    .tickets-content-wrapper {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
        padding: 0 1rem;
    }
    
    .tickets-content-wrapper.expanded {
        max-height: 2000px;
        opacity: 1;
        padding: 1rem;
    }
    
    /* Spacing for agent tickets table */
    .tickets-content-wrapper .table {
        margin-top: 0.75rem;
        margin-bottom: 0;
    }
    
    .tickets-content-wrapper .table tbody tr {
        border-bottom: 1px solid transparent;
    }
    
    .tickets-content-wrapper .table tbody tr:first-child {
        border-top: 1px solid transparent;
    }
    
    .tickets-content-wrapper .table tbody tr td {
        padding: 0.75rem;
    }
    
    .tickets-content-wrapper .table thead tr th {
        padding: 0.75rem;
    }
    
    .tickets-content-wrapper .table-responsive {
        padding: 0.5rem;
    }


</style>
{% endblock %}

{% block content %}
<!-- Desktop Header -->
<div class="d-flex justify-content-between align-items-start align-items-md-center mb-4 flex-column flex-md-row stats-header-desktop">
    <h2 class="mb-2 mb-md-0"><i class="fas fa-chart-line me-2"></i> Statystyki zgłoszeń</h2>
</div>

<!-- Mobile Header -->
<div class="stats-header-mobile mb-3">
    <div class="mobile-filter-controls">
        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#mobileStatsFilterModal">
            <i class="fas fa-filter me-1"></i> Filtry
            {% if period != 'month' or org_filter or agent_filter or date_from or date_to %}
            <span class="badge bg-info ms-1">!</span>
            {% endif %}
        </button>
        {% if period != 'month' or org_filter or agent_filter or date_from or date_to %}
        <a href="{% url 'statistics_dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-times me-1"></i> Wyczyść
        </a>
        {% endif %}
    </div>
</div>

<!-- Hidden data elements for JavaScript - add diagnostic information -->
<div style="display: none;">
    <div data-new-tickets="{{ new_tickets }}"></div>
    <div data-in-progress-tickets="{{ in_progress_tickets }}"></div>
    <div data-unresolved-tickets="{{ unresolved_tickets|default:0 }}"></div>
    <div data-resolved-tickets="{{ resolved_tickets }}"></div>
    <div data-closed-tickets="{{ closed_tickets }}"></div>
    <!-- Add debug data to help troubleshoot -->
    <div id="debug-ticket-counts">
        New: {{ new_tickets }}, 
        In Progress: {{ in_progress_tickets }}, 
        Unresolved: {{ unresolved_tickets|default:0 }} (debug: {{ debug_unresolved_count|default:0 }}),
        Resolved: {{ resolved_tickets }}, 
        Closed: {{ closed_tickets }}, 
        Total: {{ total_tickets }}
    </div>
    <div data-priority-distribution="{{ priority_distribution|safe }}"></div>
    <div data-category-distribution="{{ category_distribution|safe }}"></div>
    <div data-tickets-by-date="{{ tickets_by_date|safe }}"></div>
    <div data-period="{{ period }}"></div>
</div>

<!-- Desktop Filter Card -->
<div class="card mb-4 desktop-filter-card">
    <div class="card-header p-2 d-flex justify-content-between align-items-center flex-column flex-sm-row">
        <div class="mb-2 mb-sm-0">
            <i class="fas fa-filter me-1"></i> Filtry statystyk
            {% if period != 'month' or org_filter or agent_filter or date_from or date_to %}
            <span class="badge bg-info ms-2">Aktywne</span>
            {% endif %}
        </div>
        {% if period != 'month' or org_filter or agent_filter or date_from or date_to %}
        <a href="{% url 'statistics_dashboard' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-times me-1"></i> Wyczyść filtry
        </a>
        {% endif %}
    </div>
    <div class="card-body p-2">
        <form method="get" id="statsFilterForm">
            <div class="row">
                <div class="col-md-2 mb-2">
                    <label for="period">Okres:</label>
                    <select name="period" id="period" class="form-control">
                        <option value="day" {% if period == 'day' %}selected{% endif %}>Dzień</option>
                        <option value="week" {% if period == 'week' %}selected{% endif %}>Tydzień</option>
                        <option value="month" {% if period == 'month' %}selected{% endif %}>Miesiąc</option>
                        <option value="year" {% if period == 'year' %}selected{% endif %}>Rok</option>
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <label for="date_from">Od:</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from|date:'Y-m-d' }}">
                </div>
                <div class="col-md-2 mb-2">
                    <label for="date_to">Do:</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to|date:'Y-m-d' }}">
                </div>
                <div class="col-md-2 mb-2">
                    <label for="organization">Organizacja:</label>
                    <select name="organization" id="organization" class="form-control">
                        <option value="">Wszystkie</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if org_filter == org.id|stringformat:"s" %}selected{% endif %}>{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <label for="agent">Agent:</label>
                    <select name="agent" id="agent" class="form-control">
                        <option value="">Wszyscy</option>
                        {% for agent_profile in agents %}
                        <option value="{{ agent_profile.user.id }}" {% if agent_filter == agent_profile.user.id|stringformat:"s" %}selected{% endif %}>
                            {% if agent_profile.user.first_name %}{{ agent_profile.user.first_name }} {{ agent_profile.user.last_name }}{% else %}{{ agent_profile.user.username }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end mb-2">
                    <button type="submit" class="btn btn-primary btn-ripple w-100">
                        <i class="fas fa-search"></i> Zastosuj
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Mobile Statistics Filter Modal -->
<div class="modal fade mobile-filter-modal" id="mobileStatsFilterModal" tabindex="-1" aria-labelledby="mobileStatsFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mobileStatsFilterModalLabel">
                    <i class="fas fa-filter me-2"></i>Filtry statystyk
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="get" class="mobile-filter-form">
                    <div class="mb-3">
                        <label for="mobile_period" class="form-label">Okres</label>
                        <select name="period" id="mobile_period" class="form-select">
                            <option value="day" {% if period == 'day' %}selected{% endif %}>Dzień</option>
                            <option value="week" {% if period == 'week' %}selected{% endif %}>Tydzień</option>
                            <option value="month" {% if period == 'month' %}selected{% endif %}>Miesiąc</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>Rok</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_date_from" class="form-label">Data od</label>
                        <input type="date" name="date_from" id="mobile_date_from" class="form-control" value="{{ date_from|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_date_to" class="form-label">Data do</label>
                        <input type="date" name="date_to" id="mobile_date_to" class="form-control" value="{{ date_to|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_organization" class="form-label">Organizacja</label>
                        <select name="organization" id="mobile_organization" class="form-select">
                            <option value="" {% if not org_filter %}selected{% endif %}>Wszystkie</option>
                            {% for org in organizations %}
                            <option value="{{ org.id }}" {% if org_filter == org.id|stringformat:"s" %}selected{% endif %}>
                                {{ org.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_agent" class="form-label">Agent</label>
                        <select name="agent" id="mobile_agent" class="form-select">
                            <option value="" {% if not agent_filter %}selected{% endif %}>Wszyscy</option>
                            {% for agent_profile in agents %}
                            <option value="{{ agent_profile.user.id }}" {% if agent_filter == agent_profile.user.id|stringformat:"s" %}selected{% endif %}>
                                {% if agent_profile.user.first_name %}{{ agent_profile.user.first_name }} {{ agent_profile.user.last_name }}{% else %}{{ agent_profile.user.username }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <a href="{% url 'statistics_dashboard' %}" class="btn btn-outline-secondary">Wyczyść</a>
                <button type="button" class="btn btn-primary" onclick="document.querySelector('.mobile-filter-form').submit();">
                    <i class="fas fa-search me-1"></i>Zastosuj filtry
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Row - Match the dashboard's color coding for consistency -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Podsumowanie za okres: {{ date_from|date:"d.m.Y" }} - {{ date_to|date:"d.m.Y" }}</h5>
                <div class="row text-center justify-content-between">
                    <div class="col mb-3">
                        <div class="stats-card bg-light p-3 rounded h-100">
                            <h3 class="text-primary">{{ total_tickets }}</h3>
                            <p class="mb-0 text-muted">Wszystkich zgłoszeń</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-primary text-white p-3 rounded h-100">
                            <h3>{{ new_tickets }}</h3>
                            <p class="mb-0">Nowych</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-info text-white p-3 rounded h-100">
                            <h3>{{ in_progress_tickets }}</h3>
                            <p class="mb-0">W trakcie</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-warning text-dark p-3 rounded h-100">
                            <h3>{{ unresolved_tickets }}</h3>
                            <p class="mb-0">Nierozwiązane</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-success text-white p-3 rounded h-100">
                            <h3>{{ resolved_tickets }}</h3>
                            <p class="mb-0">Rozwiązanych</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-secondary text-white p-3 rounded h-100">
                            <h3>{{ closed_tickets }}</h3>
                            <p class="mb-0">Zamkniętych</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia według statusu</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia według priorytetu</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia według kategorii</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia w czasie</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Wskaźniki wydajności</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Pierwszy rząd -->
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Średni czas rozwiązania</h5>
                            <h2 class="mb-0 
                                {% if avg_resolution_hours < 24 %}performance-good
                                {% elif avg_resolution_hours < 48 %}performance-medium
                                {% else %}performance-poor{% endif %}">
                                {% if avg_resolution_hours %}
                                    {{ avg_resolution_hours|floatformat:2 }} godzin
                                {% else %}
                                    Brak danych
                                {% endif %}
                            </h2>
                            <small class="text-muted">Czas od zgłoszenia do rozwiązania</small>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Średni rzeczywisty czas wykonania</h5>
                            <h2 class="mb-0 
                                {% if avg_actual_hours %}
                                    {% if avg_actual_hours < 2 %}performance-good
                                    {% elif avg_actual_hours < 5 %}performance-medium
                                    {% else %}performance-poor{% endif %}
                                {% endif %}">
                                {% if avg_actual_hours %}
                                    {{ avg_actual_hours|floatformat:2 }} godz.
                                {% else %}
                                    Brak danych
                                {% endif %}
                            </h2>
                            <small class="text-muted">
                                {% if tickets_with_actual_time > 0 %}
                                    {{ tickets_with_actual_time }} zgłoszeń ({{ tickets_with_actual_time_percentage|floatformat:0 }}%)
                                {% else %}
                                    Brak zgłoszeń z podanym czasem
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <!-- Drugi rząd -->
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Wskaźnik rozwiązania</h5>
                            {% if total_tickets > 0 %}
                                {% widthratio resolved_tickets|add:closed_tickets total_tickets 100 as resolution_rate %}
                                <h2 class="mb-0 
                                    {% if resolution_rate > 80 %}performance-good
                                    {% elif resolution_rate > 50 %}performance-medium
                                    {% else %}performance-poor{% endif %}">
                                    {{ resolution_rate|floatformat:1 }}%
                                </h2>
                            {% else %}
                                <h2 class="mb-0">0%</h2>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Obciążenie agentów</h5>
                            {% if avg_tickets_per_agent %}
                                <h2 class="mb-0 
                                    {% if avg_tickets_per_agent < 5 %}performance-good
                                    {% elif avg_tickets_per_agent < 10 %}performance-medium
                                    {% else %}performance-poor{% endif %}">
                                    {{ avg_tickets_per_agent|floatformat:1 }} zgłoszeń/agenta
                                </h2>
                                <small class="text-muted">{{ agent_performance|length }} agent{{ agent_performance|length|pluralize:"ów" }} ze zgłoszeniami</small>
                            {% elif agents.count > 0 %}
                                <h2 class="mb-0">0 zgłoszeń/agenta</h2>
                                <small class="text-muted">{{ agents.count }} dostępn{{ agents.count|pluralize:"y,ych" }} agent{{ agents.count|pluralize:"ów" }}</small>
                            {% else %}
                                <h2 class="mb-0">Brak agentów</h2>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Performance Table -->
{% if agent_performance %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Wydajność agentów</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Agent</th>
                                <th>Liczba zgłoszeń</th>
                                <th>Rozwiązanych</th>
                                <th>% rozwiązanych</th>
                                <th>Śr. czas rozwiązania</th>
                                <th>Śr. rzeczywisty czas</th>
                                {% if agent_work_time_stats %}
                                <th>Śr. czas pracy</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for ap in agent_performance %}
                            <tr class="agent-row" data-agent-id="{{ ap.agent_id }}" style="cursor: pointer;">
                                <td>
                                    <i class="fas fa-chevron-right toggle-icon" style="transition: transform 0.2s;"></i>
                                </td>
                                <td><strong>{{ ap.agent_name }}</strong></td>
                                <td>{{ ap.ticket_count }}</td>
                                <td>{{ ap.resolved_count }}</td>
                                <td>
                                    <span class="
                                        {% if ap.resolution_rate > 80 %}text-success
                                        {% elif ap.resolution_rate > 50 %}text-warning
                                        {% else %}text-danger{% endif %}">
                                        {{ ap.resolution_rate|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>
                                    {% if ap.avg_resolution_time %}
                                        <span class="
                                            {% if ap.avg_resolution_time < 24 %}text-success
                                            {% elif ap.avg_resolution_time < 48 %}text-warning
                                            {% else %}text-danger{% endif %}">
                                            {{ ap.avg_resolution_time|floatformat:1 }} godz.
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Brak danych</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ap.avg_actual_resolution_time %}
                                        <span class="
                                            {% if ap.avg_actual_resolution_time < 2 %}text-success
                                            {% elif ap.avg_actual_resolution_time < 5 %}text-warning
                                            {% else %}text-danger{% endif %}">
                                            {{ ap.avg_actual_resolution_time|floatformat:1 }} godz.
                                        </span>
                                        <br>
                                        <small class="text-muted">({{ ap.tickets_with_actual_time }} zgł.)</small>
                                    {% else %}
                                        <span class="text-muted">Brak danych</span>
                                    {% endif %}
                                </td>
                                {% if agent_work_time_stats %}
                                <td>
                                    {% if ap.work_time_stats %}
                                        {{ ap.work_time_stats.avg_minutes_per_ticket|floatformat:1 }} min/zgłoszenie
                                    {% else %}
                                        <span class="text-muted">Brak danych</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            <tr class="agent-tickets-row" data-agent-id="{{ ap.agent_id }}">
                                <td colspan="{% if agent_work_time_stats %}8{% else %}7{% endif %}">
                                    <div class="tickets-content-wrapper bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">Zgłoszenia agenta {{ ap.agent_name }}</h6>
                                            <div class="spinner-border spinner-border-sm text-primary tickets-spinner" role="status" style="display: none;">
                                                <span class="sr-only">Ładowanie...</span>
                                            </div>
                                        </div>
                                        <div class="tickets-container"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Generate Report Button -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title mb-3">Generowanie raportu</h5>
                <p class="text-muted mb-3">
                    Wygeneruj szczegółowy raport statystyk na podstawie aktualnie wybranych filtrów. 
                    Raport będzie zawierał wszystkie dane widoczne na tej stronie w formacie Excel lub CSV.
                </p>
                <button id="generateReportBtn" class="btn btn-primary btn-ripple btn-lg">
                    <i class="fas fa-file-export"></i> Wygeneruj raport z aktualnych filtrów
                </button>
                <div id="reportStatus" class="mt-3"></div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Raport zostanie automatycznie pobrany po wygenerowaniu
                    </small>
                </div>
                
                <!-- Debug information (visible only in development) -->
                {% if debug %}
                <div class="mt-4 p-3 bg-light border rounded">
                    <h6>Informacje debugowania:</h6>
                    <small class="text-muted">
                        <strong>Okres:</strong> {{ date_from|date:"Y-m-d" }} - {{ date_to|date:"Y-m-d" }}<br>
                        <strong>Organizacja:</strong> {% if org_filter %}{{ org_filter }}{% else %}Wszystkie{% endif %}<br>
                        <strong>Agent:</strong> {% if agent_filter %}{{ agent_filter }}{% else %}Wszyscy{% endif %}<br>
                        <strong>Łączna liczba zgłoszeń:</strong> {{ total_tickets }}<br>
                        <strong>Dostępne organizacje:</strong> {{ organizations.count }}<br>
                        <strong>Dostępni agenci:</strong> {{ agents.count }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Ensure CSRF token is available for AJAX requests -->
{% csrf_token %}

<!-- Chart.js and our custom script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Agent tickets toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const agentRows = document.querySelectorAll('.agent-row');
    const dateFrom = document.querySelector('input[name="date_from"]').value;
    const dateTo = document.querySelector('input[name="date_to"]').value;
    
    agentRows.forEach(row => {
        row.addEventListener('click', function() {
            const agentId = this.dataset.agentId;
            const ticketsRow = document.querySelector(`.agent-tickets-row[data-agent-id="${agentId}"]`);
            const contentWrapper = ticketsRow.querySelector('.tickets-content-wrapper');
            const ticketsContainer = ticketsRow.querySelector('.tickets-container');
            const spinner = ticketsRow.querySelector('.tickets-spinner');
            const toggleIcon = this.querySelector('.toggle-icon');
            
            // Toggle expanded state on the content wrapper
            const isExpanded = contentWrapper.classList.contains('expanded');
            
            if (!isExpanded) {
                // Expand tickets
                contentWrapper.classList.add('expanded');
                toggleIcon.style.transform = 'rotate(90deg)';
                
                // Check if tickets already loaded
                if (ticketsContainer.innerHTML === '') {
                    // Load tickets via AJAX
                    spinner.style.display = 'inline-block';
                    
                    const url = `/api/agent-tickets/${agentId}/?date_from=${dateFrom}&date_to=${dateTo}`;
                    
                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        spinner.style.display = 'none';
                        
                        if (data.success && data.tickets.length > 0) {
                            let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
                            html += '<thead><tr>';
                            html += '<th>ID</th>';
                            html += '<th>Tytuł</th>';
                            html += '<th>Status</th>';
                            html += '<th>Priorytet</th>';
                            html += '<th>Kategoria</th>';
                            html += '<th>Utworzono</th>';
                            html += '<th>Akcje</th>';
                            html += '</tr></thead><tbody>';
                            
                            data.tickets.forEach(ticket => {
                                // Bootstrap 5 badge classes with proper colors
                                let statusClass = '';
                                if (ticket.status_raw === 'new') statusClass = 'bg-primary';
                                else if (ticket.status_raw === 'in_progress') statusClass = 'bg-info';
                                else if (ticket.status_raw === 'unresolved') statusClass = 'bg-warning text-dark';
                                else if (ticket.status_raw === 'resolved') statusClass = 'bg-success';
                                else if (ticket.status_raw === 'closed') statusClass = 'bg-secondary';
                                else statusClass = 'bg-secondary';
                                
                                let priorityClass = '';
                                if (ticket.priority_raw === 'low') priorityClass = 'bg-secondary';
                                else if (ticket.priority_raw === 'medium') priorityClass = 'bg-info';
                                else if (ticket.priority_raw === 'high') priorityClass = 'bg-warning text-dark';
                                else if (ticket.priority_raw === 'critical') priorityClass = 'bg-danger';
                                else priorityClass = 'bg-secondary';
                                
                                html += '<tr>';
                                html += `<td><strong>#${ticket.id}</strong></td>`;
                                html += `<td><a href="${ticket.url}" target="_blank">${ticket.title}</a></td>`;
                                html += `<td><span class="badge ${statusClass}">${ticket.status}</span></td>`;
                                html += `<td><span class="badge ${priorityClass}">${ticket.priority}</span></td>`;
                                html += `<td>${ticket.category}</td>`;
                                html += `<td><small>${ticket.created_at}</small></td>`;
                                html += `<td><a href="${ticket.url}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fas fa-eye"></i></a></td>`;
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table></div>';
                            html += `<p class="text-muted mb-0"><small>Łącznie: ${data.count} zgłoszeń w wybranym okresie</small></p>`;
                            
                            ticketsContainer.innerHTML = html;
                        } else {
                            ticketsContainer.innerHTML = '<p class="text-muted mb-0">Brak zgłoszeń w wybranym okresie</p>';
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';
                        ticketsContainer.innerHTML = '<p class="text-danger mb-0">Błąd podczas ładowania zgłoszeń</p>';
                        console.error('Error loading agent tickets:', error);
                    });
                }
            } else {
                // Collapse tickets
                contentWrapper.classList.remove('expanded');
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        });
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'crm/js/statistics.js' %}"></script>
{% endblock %}
