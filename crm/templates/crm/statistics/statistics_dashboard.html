{% extends 'crm/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Statystyki | System Helpdesk{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .data-table {
        font-size: 0.85rem;  /* Smaller font */
    }
    /* More compact filter elements */
    .filter-section {
        background-color: #f8f9fa;
        padding: 12px;  /* Reduced padding */
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .filter-section label {
        font-size: 0.85rem;
        margin-bottom: 0.2rem;
    }
    .filter-section .form-control {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }
    /* Card headers with less padding */
    .card-header {
        padding: 0.75rem 1rem;
    }
    /* Compact stats row */
    .stat-card-label {
        font-size: 0.85rem;
        white-space: nowrap;
    }
    .performance-indicator {
        font-weight: bold;
    }
    .performance-good {
        color: #28a745;
    }
    .performance-medium {
        color: #ffc107;
    }
    .performance-poor {
        color: #dc3545;
    }
    
    /* Mobile filter styles */
    .mobile-filter-controls {
        display: none;
    }
    
    .desktop-filter-card {
        display: block;
    }
    
    @media (max-width: 576px) {
        .mobile-filter-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .desktop-filter-card {
            display: none;
        }
        
        .mobile-filter-modal .modal-dialog {
            margin: 0;
        }
    }
    
    /* Statistics header for mobile */
    .stats-header-mobile {
        display: none;
    }
    
    .stats-header-desktop {
        display: block;
    }
    
    @media (max-width: 576px) {
        .stats-header-mobile {
            display: block;
        }
        
        .stats-header-desktop {
            display: none;
        }
    }
    
    /* Smooth animation for agent tickets expandable rows */
    .agent-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .agent-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .agent-tickets-row td {
        padding: 0 !important;
        border: none !important;
    }
    
    .tickets-content-wrapper {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
        padding: 0 1rem;
        border-radius: 8px;
    }
    
    .tickets-content-wrapper.expanded {
        max-height: 2000px;
        opacity: 1;
        padding: 1rem;
        border: 1px solid #dee2e6;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        background-color: #f8f9fa;
    }
    
    /* Dark mode - używamy data-theme="dark" zamiast data-bs-theme */
    [data-theme="dark"] .tickets-content-wrapper.expanded {
        border-color: #4a4a4a !important;
        background-color: #1e1e1e !important;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* Nagłówek w tickets wrapper */
    .tickets-content-wrapper .d-flex {
        background-color: transparent !important;
    }
    
    .tickets-content-wrapper h6 {
        color: inherit;
        background-color: transparent !important;
    }
    
    [data-theme="dark"] .tickets-content-wrapper h6 {
        color: #f8f9fa;
        background-color: transparent !important;
    }
    
    /* Tickets container i text-muted */
    .tickets-content-wrapper .tickets-container {
        background-color: transparent !important;
    }
    
    .tickets-content-wrapper .tickets-container p {
        background-color: transparent !important;
    }
    
    .tickets-content-wrapper .table-responsive {
        background-color: transparent !important;
    }
    
    [data-theme="dark"] .tickets-content-wrapper .text-muted {
        color: #adb5bd !important;
        background-color: transparent !important;
    }
    
    /* Spacing for tickets table */
    .tickets-content-wrapper .table-responsive {
        margin-top: 0.75rem;
    }
    
    .tickets-content-wrapper .table {
        margin-bottom: 0.5rem;
        border-spacing: 0 0.25rem;
        border-collapse: separate;
    }
    
    .tickets-content-wrapper .table thead th {
        padding: 0.75rem;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
        vertical-align: middle;
    }
    
    .tickets-content-wrapper .table tbody tr {
        height: 2.5rem;
    }
    
    .tickets-content-wrapper .table tbody tr td {
        padding: 0.5rem 0.75rem;
        text-align: center;
        vertical-align: middle;
    }
    
    /* Tytuł wyrównany do lewej */
    .tickets-content-wrapper .table tbody tr td:nth-child(2) {
        text-align: left;
    }
    
    /* Dark mode table styling */
    [data-theme="dark"] .tickets-content-wrapper .table {
        color: #dee2e6;
    }
    
    [data-theme="dark"] .tickets-content-wrapper .table thead th {
        border-bottom-color: #495057;
        color: #f8f9fa;
    }
    
    [data-theme="dark"] .tickets-content-wrapper .table tbody tr {
        border-color: #495057;
    }
    
    [data-theme="dark"] .tickets-content-wrapper .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }


</style>
{% endblock %}

{% block content %}
<!-- Desktop Header -->
<div class="d-flex justify-content-between align-items-start align-items-md-center mb-4 flex-column flex-md-row stats-header-desktop">
    <h2 class="mb-2 mb-md-0"><i class="fas fa-chart-line me-2"></i> Statystyki zgłoszeń</h2>
</div>

<!-- Mobile Header -->
<div class="stats-header-mobile mb-3">
    <div class="mobile-filter-controls">
        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#mobileStatsFilterModal">
            <i class="fas fa-filter me-1"></i> Filtry
            {% if period != 'month' or org_filter or agent_filter or on_duty_filter or date_from or date_to %}
            <span class="badge bg-info ms-1">!</span>
            {% endif %}
        </button>
        {% if period != 'month' or org_filter or agent_filter or on_duty_filter or date_from or date_to %}
        <a href="{% url 'statistics_dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-times me-1"></i> Wyczyść
        </a>
        {% endif %}
    </div>
</div>

<!-- Hidden data elements for JavaScript - add diagnostic information -->
<div style="display: none;">
    <div data-new-tickets="{{ new_tickets }}"></div>
    <div data-in-progress-tickets="{{ in_progress_tickets }}"></div>
    <div data-unresolved-tickets="{{ unresolved_tickets|default:0 }}"></div>
    <div data-resolved-tickets="{{ resolved_tickets }}"></div>
    <div data-closed-tickets="{{ closed_tickets }}"></div>
    <!-- Add debug data to help troubleshoot -->
    <div id="debug-ticket-counts">
        New: {{ new_tickets }}, 
        In Progress: {{ in_progress_tickets }}, 
        Unresolved: {{ unresolved_tickets|default:0 }} (debug: {{ debug_unresolved_count|default:0 }}),
        Resolved: {{ resolved_tickets }}, 
        Closed: {{ closed_tickets }}, 
        Total: {{ total_tickets }}
    </div>
    <div data-priority-distribution="{{ priority_distribution|safe }}"></div>
    <div data-category-distribution="{{ category_distribution|safe }}"></div>
    <div data-tickets-by-date="{{ tickets_by_date|safe }}"></div>
    <div data-period="{{ period }}"></div>
</div>

<!-- Desktop Filter Card -->
<div class="card mb-4 desktop-filter-card">
    <div class="card-header p-2 d-flex justify-content-between align-items-center flex-column flex-sm-row">
        <div class="mb-2 mb-sm-0">
            <i class="fas fa-filter me-1"></i> Filtry statystyk
            {% if period != 'month' or org_filter or agent_filter or on_duty_filter or date_from or date_to %}
            <span class="badge bg-info ms-2">Aktywne</span>
            {% endif %}
        </div>
        {% if period != 'month' or org_filter or agent_filter or on_duty_filter or date_from or date_to %}
        <a href="{% url 'statistics_dashboard' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-times me-1"></i> Wyczyść filtry
        </a>
        {% endif %}
    </div>
    <div class="card-body p-2">
        <form method="get" id="statsFilterForm">
            <div class="row">
                <div class="col-md-2 mb-2">
                    <label for="period">Okres:</label>
                    <select name="period" id="period" class="form-control">
                        <option value="day" {% if period == 'day' %}selected{% endif %}>Dzień</option>
                        <option value="week" {% if period == 'week' %}selected{% endif %}>Tydzień</option>
                        <option value="month" {% if period == 'month' %}selected{% endif %}>Miesiąc</option>
                        <option value="year" {% if period == 'year' %}selected{% endif %}>Rok</option>
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <label for="date_from">Od:</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from|date:'Y-m-d' }}">
                </div>
                <div class="col-md-2 mb-2">
                    <label for="date_to">Do:</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to|date:'Y-m-d' }}">
                </div>
                <div class="col-md-3 mb-2">
                    <label for="organization">Organizacja:</label>
                    <select name="organization" id="organization" class="form-control">
                        <option value="">Wszystkie</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}" {% if org_filter == org.id|stringformat:"s" %}selected{% endif %}>{{ org.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label for="agent">Agent:</label>
                    <select name="agent" id="agent" class="form-control">
                        <option value="">Wszyscy</option>
                        {% for agent_profile in agents %}
                        <option value="{{ agent_profile.user.id }}" {% if agent_filter == agent_profile.user.id|stringformat:"s" %}selected{% endif %}>
                            {% if agent_profile.user.first_name %}{{ agent_profile.user.first_name }} {{ agent_profile.user.last_name }}{% else %}{{ agent_profile.user.username }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-2">
                    <label for="on_duty">Dyżur:</label>
                    <select name="on_duty" id="on_duty" class="form-control">
                        <option value="">Wszystkie</option>
                        <option value="true" {% if on_duty_filter == 'true' %}selected{% endif %}>Tak</option>
                        <option value="false" {% if on_duty_filter == 'false' %}selected{% endif %}>Nie</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end mb-2">
                    <button type="submit" class="btn btn-primary btn-ripple w-100">
                        <i class="fas fa-search"></i> Zastosuj
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Mobile Statistics Filter Modal -->
<div class="modal fade mobile-filter-modal" id="mobileStatsFilterModal" tabindex="-1" aria-labelledby="mobileStatsFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mobileStatsFilterModalLabel">
                    <i class="fas fa-filter me-2"></i>Filtry statystyk
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="get" class="mobile-filter-form">
                    <div class="mb-3">
                        <label for="mobile_period" class="form-label">Okres</label>
                        <select name="period" id="mobile_period" class="form-select">
                            <option value="day" {% if period == 'day' %}selected{% endif %}>Dzień</option>
                            <option value="week" {% if period == 'week' %}selected{% endif %}>Tydzień</option>
                            <option value="month" {% if period == 'month' %}selected{% endif %}>Miesiąc</option>
                            <option value="year" {% if period == 'year' %}selected{% endif %}>Rok</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_date_from" class="form-label">Data od</label>
                        <input type="date" name="date_from" id="mobile_date_from" class="form-control" value="{{ date_from|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_date_to" class="form-label">Data do</label>
                        <input type="date" name="date_to" id="mobile_date_to" class="form-control" value="{{ date_to|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_organization" class="form-label">Organizacja</label>
                        <select name="organization" id="mobile_organization" class="form-select">
                            <option value="" {% if not org_filter %}selected{% endif %}>Wszystkie</option>
                            {% for org in organizations %}
                            <option value="{{ org.id }}" {% if org_filter == org.id|stringformat:"s" %}selected{% endif %}>
                                {{ org.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_agent" class="form-label">Agent</label>
                        <select name="agent" id="mobile_agent" class="form-select">
                            <option value="" {% if not agent_filter %}selected{% endif %}>Wszyscy</option>
                            {% for agent_profile in agents %}
                            <option value="{{ agent_profile.user.id }}" {% if agent_filter == agent_profile.user.id|stringformat:"s" %}selected{% endif %}>
                                {% if agent_profile.user.first_name %}{{ agent_profile.user.first_name }} {{ agent_profile.user.last_name }}{% else %}{{ agent_profile.user.username }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mobile_on_duty" class="form-label">Dyżur</label>
                        <select name="on_duty" id="mobile_on_duty" class="form-select">
                            <option value="" {% if not on_duty_filter %}selected{% endif %}>Wszystkie</option>
                            <option value="true" {% if on_duty_filter == 'true' %}selected{% endif %}>Tak</option>
                            <option value="false" {% if on_duty_filter == 'false' %}selected{% endif %}>Nie</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <a href="{% url 'statistics_dashboard' %}" class="btn btn-outline-secondary">Wyczyść</a>
                <button type="button" class="btn btn-primary" onclick="document.querySelector('.mobile-filter-form').submit();">
                    <i class="fas fa-search me-1"></i>Zastosuj filtry
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Row - Match the dashboard's color coding for consistency -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Podsumowanie za okres: {{ date_from|date:"d.m.Y" }} - {{ date_to|date:"d.m.Y" }}</h5>
                <div class="row text-center justify-content-between">
                    <div class="col mb-3">
                        <div class="stats-card bg-light p-3 rounded h-100">
                            <h3 class="text-primary">{{ total_tickets }}</h3>
                            <p class="mb-0 text-muted">Wszystkich zgłoszeń</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-primary text-white p-3 rounded h-100">
                            <h3>{{ new_tickets }}</h3>
                            <p class="mb-0">Nowych</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-info text-white p-3 rounded h-100">
                            <h3>{{ in_progress_tickets }}</h3>
                            <p class="mb-0">W trakcie</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-warning text-dark p-3 rounded h-100">
                            <h3>{{ unresolved_tickets }}</h3>
                            <p class="mb-0">Nierozwiązane</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-success text-white p-3 rounded h-100">
                            <h3>{{ resolved_tickets }}</h3>
                            <p class="mb-0">Rozwiązanych</p>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <div class="stats-card bg-secondary text-white p-3 rounded h-100">
                            <h3>{{ closed_tickets }}</h3>
                            <p class="mb-0">Zamkniętych</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia według statusu</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia według priorytetu</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia według kategorii</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Zgłoszenia w czasie</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Wskaźniki wydajności</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Pierwszy rząd -->
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Średni czas rozwiązania</h5>
                            <h2 class="mb-0 
                                {% if avg_resolution_hours < 24 %}performance-good
                                {% elif avg_resolution_hours < 48 %}performance-medium
                                {% else %}performance-poor{% endif %}">
                                {% if avg_resolution_hours %}
                                    {{ avg_resolution_hours|floatformat:2 }} godzin
                                {% else %}
                                    Brak danych
                                {% endif %}
                            </h2>
                            <small class="text-muted">Czas od zgłoszenia do rozwiązania</small>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Średni rzeczywisty czas wykonania</h5>
                            <h2 class="mb-0 
                                {% if avg_actual_hours %}
                                    {% if avg_actual_hours < 2 %}performance-good
                                    {% elif avg_actual_hours < 5 %}performance-medium
                                    {% else %}performance-poor{% endif %}
                                {% endif %}">
                                {% if avg_actual_hours %}
                                    {{ avg_actual_hours|floatformat:2 }} godz.
                                {% else %}
                                    Brak danych
                                {% endif %}
                            </h2>
                            <small class="text-muted">
                                {% if tickets_with_actual_time > 0 %}
                                    {{ tickets_with_actual_time }} zgłoszeń ({{ tickets_with_actual_time_percentage|floatformat:0 }}%)
                                {% else %}
                                    Brak zgłoszeń z podanym czasem
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <!-- Drugi rząd -->
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Wskaźnik rozwiązania</h5>
                            {% if total_tickets > 0 %}
                                {% widthratio resolved_tickets|add:closed_tickets total_tickets 100 as resolution_rate %}
                                <h2 class="mb-0 
                                    {% if resolution_rate > 80 %}performance-good
                                    {% elif resolution_rate > 50 %}performance-medium
                                    {% else %}performance-poor{% endif %}">
                                    {{ resolution_rate|floatformat:1 }}%
                                </h2>
                            {% else %}
                                <h2 class="mb-0">0%</h2>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="stats-card bg-light p-3 rounded text-center h-100">
                            <h5 class="text-muted">Obciążenie agentów</h5>
                            {% if avg_tickets_per_agent %}
                                <h2 class="mb-0 
                                    {% if avg_tickets_per_agent < 5 %}performance-good
                                    {% elif avg_tickets_per_agent < 10 %}performance-medium
                                    {% else %}performance-poor{% endif %}">
                                    {{ avg_tickets_per_agent|floatformat:1 }} zgłoszeń/agenta
                                </h2>
                                <small class="text-muted">{{ agent_performance|length }} agent{{ agent_performance|length|pluralize:"ów" }} ze zgłoszeniami</small>
                            {% elif agents.count > 0 %}
                                <h2 class="mb-0">0 zgłoszeń/agenta</h2>
                                <small class="text-muted">{{ agents.count }} dostępn{{ agents.count|pluralize:"y,ych" }} agent{{ agents.count|pluralize:"ów" }}</small>
                            {% else %}
                                <h2 class="mb-0">Brak agentów</h2>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Performance Table -->
{% if agent_performance %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Wydajność agentów</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Agent</th>
                                <th>Liczba zgłoszeń</th>
                                <th>Rozwiązanych</th>
                                <th>% rozwiązanych</th>
                                <th>Śr. czas rozwiązania</th>
                                <th>Śr. rzeczywisty czas</th>
                                {% if agent_work_time_stats %}
                                <th>Śr. czas pracy</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for ap in agent_performance %}
                            <tr class="agent-row" data-agent-id="{{ ap.agent_id }}" style="cursor: pointer;">
                                <td>
                                    <i class="fas fa-chevron-right toggle-icon" style="transition: transform 0.2s;"></i>
                                </td>
                                <td><strong>{{ ap.agent_name }}</strong></td>
                                <td>{{ ap.ticket_count }}</td>
                                <td>{{ ap.resolved_count }}</td>
                                <td>
                                    <span class="
                                        {% if ap.resolution_rate > 80 %}text-success
                                        {% elif ap.resolution_rate > 50 %}text-warning
                                        {% else %}text-danger{% endif %}">
                                        {{ ap.resolution_rate|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>
                                    {% if ap.avg_resolution_time %}
                                        <span class="
                                            {% if ap.avg_resolution_time < 24 %}text-success
                                            {% elif ap.avg_resolution_time < 48 %}text-warning
                                            {% else %}text-danger{% endif %}">
                                            {{ ap.avg_resolution_time|floatformat:1 }} godz.
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Brak danych</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ap.avg_actual_resolution_time %}
                                        <span class="
                                            {% if ap.avg_actual_resolution_time < 2 %}text-success
                                            {% elif ap.avg_actual_resolution_time < 5 %}text-warning
                                            {% else %}text-danger{% endif %}">
                                            {{ ap.avg_actual_resolution_time|floatformat:1 }} godz.
                                        </span>
                                        <br>
                                        <small class="text-muted">({{ ap.tickets_with_actual_time }} zgł.)</small>
                                    {% else %}
                                        <span class="text-muted">Brak danych</span>
                                    {% endif %}
                                </td>
                                {% if agent_work_time_stats %}
                                <td>
                                    {% if ap.work_time_stats %}
                                        {{ ap.work_time_stats.avg_minutes_per_ticket|floatformat:1 }} min/zgłoszenie
                                    {% else %}
                                        <span class="text-muted">Brak danych</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            <tr class="agent-tickets-row" data-agent-id="{{ ap.agent_id }}">
                                <td colspan="{% if agent_work_time_stats %}8{% else %}7{% endif %}">
                                    <div class="tickets-content-wrapper">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">Zgłoszenia agenta {{ ap.agent_name }}</h6>
                                            <div class="spinner-border spinner-border-sm text-primary tickets-spinner" role="status" style="display: none;">
                                                <span class="sr-only">Ładowanie...</span>
                                            </div>
                                        </div>
                                        <div class="tickets-container"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Generate Report Button -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title mb-3">Generowanie raportu</h5>
                <p class="text-muted mb-3">
                    Wygeneruj szczegółowy raport statystyk na podstawie aktualnie wybranych filtrów. 
                    Raport będzie zawierał wszystkie dane widoczne na tej stronie w formacie Excel lub CSV.
                </p>
                <button id="generateReportBtn" class="btn btn-primary btn-ripple btn-lg">
                    <i class="fas fa-file-export"></i> Wygeneruj raport z aktualnych filtrów
                </button>
                <button id="generateOrgReportBtn" class="btn btn-success btn-ripple btn-lg ms-2">
                    <i class="fas fa-building"></i> Raport rzeczywistych czasów firm
                </button>
                <div id="reportStatus" class="mt-3"></div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Raport zostanie automatycznie pobrany po wygenerowaniu
                    </small>
                </div>
                
                <!-- Debug information (visible only in development) -->
                {% if debug %}
                <div class="mt-4 p-3 bg-light border rounded">
                    <h6>Informacje debugowania:</h6>
                    <small class="text-muted">
                        <strong>Okres:</strong> {{ date_from|date:"Y-m-d" }} - {{ date_to|date:"Y-m-d" }}<br>
                        <strong>Organizacja:</strong> {% if org_filter %}{{ org_filter }}{% else %}Wszystkie{% endif %}<br>
                        <strong>Agent:</strong> {% if agent_filter %}{{ agent_filter }}{% else %}Wszyscy{% endif %}<br>
                        <strong>Łączna liczba zgłoszeń:</strong> {{ total_tickets }}<br>
                        <strong>Dostępne organizacje:</strong> {{ organizations.count }}<br>
                        <strong>Dostępni agenci:</strong> {{ agents.count }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Ensure CSRF token is available for AJAX requests -->
{% csrf_token %}

<!-- Chart.js and our custom script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Agent tickets toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const agentRows = document.querySelectorAll('.agent-row');
    const dateFrom = document.querySelector('input[name="date_from"]').value;
    const dateTo = document.querySelector('input[name="date_to"]').value;
    const organizationFilter = document.getElementById('organization') ? document.getElementById('organization').value : '';
    const onDutyFilter = document.getElementById('on_duty') ? document.getElementById('on_duty').value : '';
    
    agentRows.forEach(row => {
        row.addEventListener('click', function() {
            const agentId = this.dataset.agentId;
            const ticketsRow = document.querySelector(`.agent-tickets-row[data-agent-id="${agentId}"]`);
            const contentWrapper = ticketsRow.querySelector('.tickets-content-wrapper');
            const ticketsContainer = ticketsRow.querySelector('.tickets-container');
            const spinner = ticketsRow.querySelector('.tickets-spinner');
            const toggleIcon = this.querySelector('.toggle-icon');
            
            // Toggle expanded state on the content wrapper
            const isExpanded = contentWrapper.classList.contains('expanded');
            
            if (!isExpanded) {
                // Expand tickets
                contentWrapper.classList.add('expanded');
                toggleIcon.style.transform = 'rotate(90deg)';
                
                // Check if tickets already loaded
                if (ticketsContainer.innerHTML === '') {
                    // Load tickets via AJAX
                    spinner.style.display = 'inline-block';
                    
                    let url = `/api/agent-tickets/${agentId}/?date_from=${dateFrom}&date_to=${dateTo}`;
                    if (organizationFilter) url += `&organization=${organizationFilter}`;
                    if (onDutyFilter) url += `&on_duty=${onDutyFilter}`;
                    
                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        spinner.style.display = 'none';
                        
                        if (data.success && data.tickets.length > 0) {
                            let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
                            html += '<thead><tr>';
                            html += '<th>ID</th>';
                            html += '<th>Tytuł</th>';
                            html += '<th>Status</th>';
                            html += '<th>Priorytet</th>';
                            html += '<th>Kategoria</th>';
                            html += '<th>Utworzono</th>';
                            html += '<th>Akcje</th>';
                            html += '</tr></thead><tbody>';
                            
                            data.tickets.forEach(ticket => {
                                // Bootstrap 5 badge classes with proper colors
                                let statusClass = '';
                                if (ticket.status_raw === 'new') statusClass = 'bg-primary';
                                else if (ticket.status_raw === 'in_progress') statusClass = 'bg-info';
                                else if (ticket.status_raw === 'unresolved') statusClass = 'bg-warning text-dark';
                                else if (ticket.status_raw === 'resolved') statusClass = 'bg-success';
                                else if (ticket.status_raw === 'closed') statusClass = 'bg-secondary';
                                else statusClass = 'bg-secondary';
                                
                                let priorityClass = '';
                                if (ticket.priority_raw === 'low') priorityClass = 'bg-secondary';
                                else if (ticket.priority_raw === 'medium') priorityClass = 'bg-info';
                                else if (ticket.priority_raw === 'high') priorityClass = 'bg-warning text-dark';
                                else if (ticket.priority_raw === 'critical') priorityClass = 'bg-danger';
                                else priorityClass = 'bg-secondary';
                                
                                html += '<tr>';
                                html += `<td><strong>#${ticket.id}</strong></td>`;
                                html += `<td><a href="${ticket.url}" target="_blank">${ticket.title}</a></td>`;
                                html += `<td><span class="badge ${statusClass}">${ticket.status}</span></td>`;
                                html += `<td><span class="badge ${priorityClass}">${ticket.priority}</span></td>`;
                                html += `<td>${ticket.category}</td>`;
                                html += `<td><small>${ticket.created_at}</small></td>`;
                                html += `<td><a href="${ticket.url}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fas fa-eye"></i></a></td>`;
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table></div>';
                            html += `<p class="text-muted mb-0"><small>Łącznie: ${data.count} zgłoszeń w wybranym okresie</small></p>`;
                            
                            ticketsContainer.innerHTML = html;
                        } else {
                            ticketsContainer.innerHTML = '<p class="text-muted mb-0">Brak zgłoszeń w wybranym okresie</p>';
                        }
                    })
                    .catch(error => {
                        spinner.style.display = 'none';
                        ticketsContainer.innerHTML = '<p class="text-danger mb-0">Błąd podczas ładowania zgłoszeń</p>';
                        console.error('Error loading agent tickets:', error);
                    });
                }
            } else {
                // Collapse tickets
                contentWrapper.classList.remove('expanded');
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        });
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Statistics Dashboard JavaScript
 * Handles chart rendering and interactive functionality for the statistics dashboard
 */

document.addEventListener('DOMContentLoaded', function() {
    // Chart.js global defaults
    Chart.defaults.font.family = "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.color = '#666';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    // Update color schemes for consistency with dashboard
    const colorSchemes = {
        status: {
            backgroundColor: [
                '#007bff', // New - primary - light blue
                '#17a2b8', // In Progress - info - teal
                '#ffc107', // Unresolved - warning - yellow
                '#28a745', // Resolved - success - green
                '#6c757d'  // Closed - secondary - gray
            ],
            borderColor: '#fff',
            borderWidth: 1
        },
        priority: {
            backgroundColor: [
                '#6c757d', // Low - secondary - gray
                '#17a2b8', // Medium - info -   teal
                '#ffc107', // High - warning -  yellow
                '#dc3545'  // Critical - danger - red
            ],
            borderColor: '#fff',
            borderWidth: 1
        },
        category: {
            backgroundColor: [
                '#fd7e14', // Hardware - orange
                '#20c997', // Software - teal
                '#6f42c1', // Network - purple
                '#e83e8c', // Account - pink
                '#6c757d'  // Other - secondary
            ],
            borderColor: '#fff',
            borderWidth: 1
        },
        timeline: {
            borderColor: '#007bff',
            backgroundColor: 'rgba(0,123,255,0.2)',
            pointBackgroundColor: '#007bff',
            pointBorderColor: '#fff',
            pointRadius: 4
        }
    };

    /**
     * Get and parse data from hidden elements in the HTML
     */
    const getChartData = () => {
        // Extract ticket count data with better error handling for missing elements
        const tickets = {
            new: parseInt(document.querySelector('[data-new-tickets]')?.getAttribute('data-new-tickets')) || 0,
            inProgress: parseInt(document.querySelector('[data-in-progress-tickets]')?.getAttribute('data-in-progress-tickets')) || 0,
            unresolved: parseInt(document.querySelector('[data-unresolved-tickets]')?.getAttribute('data-unresolved-tickets')) || 0,
            resolved: parseInt(document.querySelector('[data-resolved-tickets]')?.getAttribute('data-resolved-tickets')) || 0,
            closed: parseInt(document.querySelector('[data-closed-tickets]')?.getAttribute('data-closed-tickets')) || 0
        };

        // Enhanced debug output to help troubleshoot
        console.log("Ticket data parsed from HTML:", tickets);
        console.log("Debug ticket counts from HTML:", document.getElementById('debug-ticket-counts')?.textContent);
        
        // Parse JSON data for distributions
        let priorityDistribution = [];
        let categoryDistribution = [];
        let ticketsByDate = [];

        try {
            const priorityData = document.querySelector('[data-priority-distribution]').getAttribute('data-priority-distribution');
            priorityDistribution = JSON.parse(priorityData.replace(/'/g, '"')) || [];
        } catch (e) {
            console.error('Error parsing priority distribution data:', e);
        }

        try {
            const categoryData = document.querySelector('[data-category-distribution]').getAttribute('data-category-distribution');
            categoryDistribution = JSON.parse(categoryData.replace(/'/g, '"')) || [];
        } catch (e) {
            console.error('Error parsing category distribution data:', e);
        }

        try {
            const timelineData = document.querySelector('[data-tickets-by-date]').getAttribute('data-tickets-by-date');
            ticketsByDate = JSON.parse(timelineData.replace(/'/g, '"')) || [];
        } catch (e) {
            console.error('Error parsing timeline data:', e);
        }

        const period = document.querySelector('[data-period]').getAttribute('data-period') || 'month';

        return {
            tickets,
            priorityDistribution,
            categoryDistribution,
            ticketsByDate,
            period
        };
    };

    /**
     * Format dates based on period type
     */
    const formatDate = (dateString, period) => {
        const date = new Date(dateString);
        switch (period) {
            case 'day':
                return date.toLocaleDateString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            case 'week':
                return `Tydz. ${getWeekNumber(date)} (${date.toLocaleDateString('pl-PL', { month: 'short', day: 'numeric' })})`;
            case 'month':
                return date.toLocaleDateString('pl-PL', { year: 'numeric', month: 'short' });
            case 'year':
                return date.getFullYear().toString();
            default:
                return date.toLocaleDateString('pl-PL');
        }
    };

    /**
     * Get week number from date
     */
    const getWeekNumber = (date) => {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    };

    /**
     * Translate status codes to readable Polish labels with correct pluralization
     */
    const getStatusLabel = (status) => {
        const labels = {
            'new': 'Nowe',
            'in_progress': 'W trakcie',
            'unresolved': 'Nierozwiązane',
            'resolved': 'Rozwiązane',
            'closed': 'Zamknięte'
        };
        return labels[status] || status;
    };

    /**
     * Translate priority codes to readable Polish labels
     */
    const getPriorityLabel = (priority) => {
        const labels = {
            'low': 'Niski',
            'medium': 'Średni',
            'high': 'Wysoki',
            'critical': 'Krytyczny'
        };
        return labels[priority] || priority;
    };

    /**
     * Translate category codes to readable Polish labels
     */
    const getCategoryLabel = (category) => {
        const labels = {
            'hardware': 'Sprzęt',
            'software': 'Oprogramowanie',
            'network': 'Sieć',
            'account': 'Konto',
            'other': 'Inne'
        };
        return labels[category] || category;
    };

    /**
     * Initialize the status distribution chart
     */
    const initStatusChart = (chartData) => {
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        
        // Extra detailed debug output for troubleshooting
        console.log("Chart data for status:", chartData.tickets);
        console.log("Unresolved tickets count:", chartData.tickets.unresolved);
        
        const statusData = {
            labels: ['Nowe', 'W trakcie', 'Nierozwiązane', 'Rozwiązane', 'Zamknięte'],
            datasets: [{
                data: [
                    chartData.tickets.new,
                    chartData.tickets.inProgress,
                    chartData.tickets.unresolved,
                    chartData.tickets.resolved,
                    chartData.tickets.closed
                ],
                backgroundColor: colorSchemes.status.backgroundColor,
                borderColor: colorSchemes.status.borderColor,
                borderWidth: colorSchemes.status.borderWidth
            }]
        };
        
        // Debug the final data that goes into the chart
        console.log("Final chart data:", statusData);
        
        return new Chart(statusCtx, {
            type: 'doughnut',
            data: statusData,
            options: {
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    };

    /**
     * Initialize the priority distribution chart
     */
    const initPriorityChart = (chartData) => {
        const priorityCtx = document.getElementById('priorityChart').getContext('2d');
        
        // Define priority order to match the color scheme
        const priorityOrder = ['low', 'medium', 'high', 'critical'];
        
        // Group and sort data according to priority order
        let priorityMap = {};
        chartData.priorityDistribution.forEach(item => {
            priorityMap[item.priority] = item.count;
        });
        
        // Transform data for the chart (in correct order)
        const priorityLabels = [];
        const priorityValues = [];
        const priorityColors = [];
        
        priorityOrder.forEach((priority, index) => {
            if (priorityMap[priority] !== undefined) {
                priorityLabels.push(getPriorityLabel(priority));
                priorityValues.push(priorityMap[priority]);
                priorityColors.push(colorSchemes.priority.backgroundColor[index]);
            }
        });

        const priorityData = {
            labels: priorityLabels,
            datasets: [{
                data: priorityValues,
                backgroundColor: priorityColors,
                borderColor: colorSchemes.priority.borderColor,
                borderWidth: colorSchemes.priority.borderWidth
            }]
        };
        
        return new Chart(priorityCtx, {
            type: 'pie',
            data: priorityData,
            options: {
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    };

    /**
     * Initialize the category distribution chart
     */
    const initCategoryChart = (chartData) => {
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        
        // Transform data for the chart
        const categoryLabels = [];
        const categoryValues = [];
        
        chartData.categoryDistribution.forEach(item => {
            categoryLabels.push(getCategoryLabel(item.category));
            categoryValues.push(item.count);
        });

        const categoryData = {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: colorSchemes.category.backgroundColor.slice(0, categoryLabels.length),
                borderColor: colorSchemes.category.borderColor,
                borderWidth: colorSchemes.category.borderWidth
            }]
        };
        
        return new Chart(categoryCtx, {
            type: 'pie',
            data: categoryData,
            options: {
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    };

    /**
     * Initialize the timeline chart
     */
    const initTimelineChart = (chartData) => {
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        
        // Transform data for the chart
        const labels = [];
        const values = [];
        
        chartData.ticketsByDate.forEach(item => {
            labels.push(formatDate(item.date, chartData.period));
            values.push(item.count);
        });
        
        const timelineData = {
            labels: labels,
            datasets: [{
                label: 'Liczba zgłoszeń',
                data: values,
                borderColor: colorSchemes.timeline.borderColor,
                backgroundColor: colorSchemes.timeline.backgroundColor,
                pointBackgroundColor: colorSchemes.timeline.pointBackgroundColor,
                pointBorderColor: colorSchemes.timeline.pointBorderColor,
                pointRadius: colorSchemes.timeline.pointRadius,
                fill: true,
                tension: 0.3
            }]
        };
        
        return new Chart(timelineCtx, {
            type: 'line',
            data: timelineData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return `Zgłoszeń: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    };

    /**
     * Update period-dependent form fields
     */
    const updateDateFields = (period) => {
        const today = new Date();
        let dateFrom = document.getElementById('date_from');
        let dateTo = document.getElementById('date_to');
        
        // Format date as YYYY-MM-DD
        const formatDateInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        switch (period) {
            case 'day':
                dateFrom.value = formatDateInput(today);
                dateTo.value = formatDateInput(today);
                break;
            case 'week': {
                // Get first day of current week (Monday)
                const firstDay = new Date(today);
                const dayOfWeek = today.getDay() || 7; // Make Sunday = 7
                firstDay.setDate(today.getDate() - dayOfWeek + 1);
                
                // Get last day of current week (Sunday)
                const lastDay = new Date(firstDay);
                lastDay.setDate(firstDay.getDate() + 6);
                
                dateFrom.value = formatDateInput(firstDay);
                dateTo.value = formatDateInput(lastDay);
                break;
            }
            case 'month': {
                // First day of current month
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                
                // Last day of current month
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                dateFrom.value = formatDateInput(firstDay);
                dateTo.value = formatDateInput(lastDay);
                break;
            }
            case 'year': {
                // First day of current year
                const firstDay = new Date(today.getFullYear(), 0, 1);
                
                // Last day of current year
                const lastDay = new Date(today.getFullYear(), 11, 31);
                
                dateFrom.value = formatDateInput(firstDay);
                dateTo.value = formatDateInput(lastDay);
                break;
            }
        }
    };

    /**
     * Handle generating statistics report
     */
    const handleGenerateReport = () => {
        const reportBtn = document.getElementById('generateReportBtn');
        const statusDiv = document.getElementById('reportStatus');
        
        if (!reportBtn || !statusDiv) return;
        
        reportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show format selection modal first
            showReportFormatModal();
        });
    };
    
    /**
     * Show modal for report format selection
     */
    const showReportFormatModal = () => {
        // Create modal HTML
        const modalHtml = `
            <div class="modal fade" id="reportFormatModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Wybierz format raportu</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="reportFormat" id="formatExcel" value="xlsx" checked>
                                <label class="form-check-label" for="formatExcel">
                                    <i class="fas fa-file-excel text-success"></i> Excel (.xlsx) - Zalecany
                                </label>
                                <small class="form-text text-muted d-block">Plik Excel z formatowaniem i wykresami</small>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="radio" name="reportFormat" id="formatCsv" value="csv">
                                <label class="form-check-label" for="formatCsv">
                                    <i class="fas fa-file-csv text-info"></i> CSV (.csv)
                                </label>
                                <small class="form-text text-muted d-block">Plik CSV do importu w innych aplikacjach</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                            <button type="button" class="btn btn-primary" id="confirmGenerateReport">
                                <i class="fas fa-download"></i> Generuj i pobierz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if present
        const existingModal = document.getElementById('reportFormatModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('reportFormatModal'));
        modal.show();
        
        // Handle confirm button
        document.getElementById('confirmGenerateReport').addEventListener('click', function() {
            const selectedFormat = document.querySelector('input[name="reportFormat"]:checked').value;
            modal.hide();
            generateReport(selectedFormat);
        });
    };
    
    /**
     * Generate and download report
     */
    const generateReport = (format) => {
        const reportBtn = document.getElementById('generateReportBtn');
        const statusDiv = document.getElementById('reportStatus');
        
        // Show loading state
        reportBtn.disabled = true;
        reportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generowanie...';
        statusDiv.innerHTML = `<i class="fas fa-info-circle"></i> Generowanie raportu ${format.toUpperCase()}, proszę czekać...`;
        statusDiv.className = 'mt-3 text-info';
        
        // Get filter values
        const period = document.getElementById('period').value;
        const dateFrom = document.getElementById('date_from').value;
        const dateTo = document.getElementById('date_to').value;
        const organization = document.getElementById('organization').value;
        const agent = document.getElementById('agent').value;
        const onDuty = document.getElementById('on_duty').value;
        
        console.log('Report generation parameters:', {
            period, dateFrom, dateTo, organization, agent, onDuty, format
        });
        
        // Validate required fields
        if (!dateFrom || !dateTo) {
            statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> Błąd: Wymagane są daty początkowa i końcowa';
            statusDiv.className = 'mt-3 text-danger';
            reportBtn.disabled = false;
            reportBtn.innerHTML = '<i class="fas fa-file-export"></i> Wygeneruj raport z aktualnych filtrów';
            return;
        }
        
        // Validate date range
        if (new Date(dateFrom) > new Date(dateTo)) {
            statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> Błąd: Data początkowa nie może być późniejsza niż końcowa';
            statusDiv.className = 'mt-3 text-danger';
            reportBtn.disabled = false;
            reportBtn.innerHTML = '<i class="fas fa-file-export"></i> Wygeneruj raport z aktualnych filtrów';
            return;
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        if (!csrfToken) {
            statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> Błąd: Brak tokenu CSRF. Odśwież stronę i spróbuj ponownie.';
            statusDiv.className = 'mt-3 text-danger';
            reportBtn.disabled = false;
            reportBtn.innerHTML = '<i class="fas fa-file-export"></i> Wygeneruj raport z aktualnych filtrów';
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('period_type', period);
        formData.append('period_start', dateFrom);
        formData.append('period_end', dateTo);
        formData.append('format', format);
        if (organization) formData.append('organization', organization);
        if (agent) formData.append('agent', agent);
        if (onDuty) formData.append('on_duty', onDuty);
        
        console.log('Sending request to /statistics/generate-report/ with data:', {
            period_type: period,
            period_start: dateFrom,
            period_end: dateTo,
            format: format,
            organization: organization || 'none',
            agent: agent || 'none',
            on_duty: onDuty || 'all'
        });
        
        // Send request with timeout
        const timeoutId = setTimeout(() => {
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ostrzeżenie: Generowanie raportu trwa dłużej niż oczekiwano. Proszę czekać...';
            statusDiv.className = 'mt-3 text-warning';
        }, 10000); // Show warning after 10 seconds
        
        fetch('/statistics/generate-report/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            clearTimeout(timeoutId);
            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers.entries()]);
            console.log('Response ok:', response.ok);
            
            // Always get the response as a blob first
            return response.blob().then(blob => {
                const contentType = response.headers.get('content-type');
                const contentDisposition = response.headers.get('content-disposition');
                
                console.log('Content-Type:', contentType);
                console.log('Content-Disposition:', contentDisposition);
                console.log('Blob size:', blob.size);
                console.log('Blob type:', blob.type);
                
                if (!response.ok) {
                    // For error responses, try to read the blob as text to get error message
                    return blob.text().then(text => {
                        console.error('Server error response:', text);
                        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                        
                        try {
                            const errorData = JSON.parse(text);
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            if (text && text.length > 0) {
                                errorMessage = text.substring(0, 200) + (text.length > 200 ? '...' : '');
                            }
                        }
                        
                        throw new Error(errorMessage);
                    });
                }
                
                // Check if this is an error response disguised as a successful response
                if (contentType && contentType.includes('application/json')) {
                    // It's a JSON error response
                    return blob.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            console.error('Server returned JSON error:', errorData);
                            throw new Error(errorData.message || 'Unknown server error');
                        } catch (parseError) {
                            console.error('Error parsing JSON response:', parseError);
                            throw new Error('Invalid JSON response from server');
                        }
                    });
                }
                
                // Check if blob is empty
                if (blob.size === 0) {
                    throw new Error('Otrzymano pusty plik');
                }
                
                // Check for file download indicators
                const isExcelFile = contentType && contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                const isCsvFile = contentType && (contentType.includes('text/csv') || contentType.includes('application/csv'));
                const hasAttachmentHeader = contentDisposition && contentDisposition.includes('attachment');
                
                // If it's clearly a file download OR we have attachment header, proceed with download
                if (isExcelFile || isCsvFile || hasAttachmentHeader || blob.size > 1000) {
                    // Extract filename from Content-Disposition header
                    let filename = `raport_statystyk_${dateFrom}_${dateTo}.${format}`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    console.log('Downloading file:', filename);
                    
                    // Create download link
                    try {
                        // Create a new blob with the correct MIME type if needed
                        let downloadBlob = blob;
                        if (format === 'xlsx' && !blob.type.includes('spreadsheet')) {
                            downloadBlob = new Blob([blob], { 
                                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                            });
                        } else if (format === 'csv' && !blob.type.includes('csv')) {
                            downloadBlob = new Blob([blob], { 
                                type: 'text/csv' 
                            });
                        }
                        
                        const url = window.URL.createObjectURL(downloadBlob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        }, 100);
                        
                        console.log('File download triggered successfully');
                        return { success: true, filename: filename };
                    } catch (downloadError) {
                        console.error('Error creating download:', downloadError);
                        throw new Error(`Błąd pobierania pliku: ${downloadError.message}`);
                    }
                } else {
                    // Unknown response type, try to read as text for debugging
                    return blob.text().then(text => {
                        console.error('Unexpected response - not a file download');
                        console.error('Response text (first 500 chars):', text.substring(0, 500));
                        
                        // Last resort: if it looks like binary data, try to download it anyway
                        if (text.charCodeAt(0) === 0x50 && text.charCodeAt(1) === 0x4B) {
                            console.log('Detected ZIP/Excel magic bytes, forcing download');
                            const binaryBlob = new Blob([blob], { 
                                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                            });
                            
                            const filename = `raport_statystyk_${dateFrom}_${dateTo}.${format}`;
                            const url = window.URL.createObjectURL(binaryBlob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            
                            setTimeout(() => {
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                            }, 100);
                            
                            return { success: true, filename: filename };
                        } else {
                            throw new Error(`Nieoczekiwany typ odpowiedzi. Sprawdź logi serwera.`);
                        }
                    });
                }
            });
        })
        .then(result => {
            if (result && result.success) {
                statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Raport został wygenerowany i pobrany: ${result.filename}`;
                statusDiv.className = 'mt-3 text-success';
                console.log('Report generation successful:', result.filename);
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error generating report:', error);
            
            let errorMessage = error.message || 'Nieznany błąd';
            
            // Add specific error details for debugging
            if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                errorMessage += ' (Błąd połączenia sieciowego)';
            } else if (error.message.includes('timeout')) {
                errorMessage += ' (Przekroczono limit czasu)';
            } else if (error.message.includes('SyntaxError')) {
                errorMessage = 'Błąd przetwarzania odpowiedzi serwera. Sprawdź format pliku.';
            }
            
            statusDiv.innerHTML = `
                <i class="fas fa-times-circle"></i> Błąd: ${errorMessage}
                <br><small class="text-muted">
                    Sprawdź konsolę przeglądarki (F12) aby uzyskać więcej informacji.
                    Jeśli problem się powtarza, skontaktuj się z administratorem.
                </small>
            `;
            statusDiv.className = 'mt-3 text-danger';
        })
        .finally(() => {
            // Reset button state
            reportBtn.disabled = false;
            reportBtn.innerHTML = '<i class="fas fa-file-export"></i> Wygeneruj raport z aktualnych filtrów';
        });
    };
    
    // Initialize all charts with data from the DOM
    const initializeAllCharts = () => {
        const chartData = getChartData();
        
        // Initialize charts
        const charts = {
            statusChart: initStatusChart(chartData),
            priorityChart: initPriorityChart(chartData),
            categoryChart: initCategoryChart(chartData),
            timelineChart: initTimelineChart(chartData)
        };
        
        return charts;
    };
    
    /**
     * Handle generating organization report
     */
    const handleGenerateOrgReport = () => {
        const reportBtn = document.getElementById('generateOrgReportBtn');
        const statusDiv = document.getElementById('reportStatus');
        
        if (!reportBtn || !statusDiv) return;
        
        reportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show loading state
            reportBtn.disabled = true;
            reportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generowanie...';
            statusDiv.innerHTML = '<i class="fas fa-info-circle"></i> Generowanie raportu firm, proszę czekać...';
            statusDiv.className = 'mt-3 text-info';
            
            // Get filter values
            const dateFrom = document.getElementById('date_from').value;
            const dateTo = document.getElementById('date_to').value;
            const organization = document.getElementById('organization').value;
            const agent = document.getElementById('agent').value;
            const onDuty = document.getElementById('on_duty').value;
            
            // Validate required fields
            if (!dateFrom || !dateTo) {
                statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> Błąd: Wymagane są daty początkowa i końcowa';
                statusDiv.className = 'mt-3 text-danger';
                reportBtn.disabled = false;
                reportBtn.innerHTML = '<i class="fas fa-building"></i> Raport rzeczywistych czasów firm';
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Create form data
            const formData = new FormData();
            formData.append('period_start', dateFrom);
            formData.append('period_end', dateTo);
            if (organization) formData.append('organization', organization);
            if (agent) formData.append('agent', agent);
            if (onDuty) formData.append('on_duty', onDuty);
            
            // Send request
            fetch('/statistics/organization-report/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Błąd podczas generowania raportu');
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `raport_firm_${dateFrom}_${dateTo}.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Raport został wygenerowany i pobrany!';
                statusDiv.className = 'mt-3 text-success';
            })
            .catch(error => {
                console.error('Error generating organization report:', error);
                statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Błąd: ${error.message}`;
                statusDiv.className = 'mt-3 text-danger';
            })
            .finally(() => {
                reportBtn.disabled = false;
                reportBtn.innerHTML = '<i class="fas fa-building"></i> Raport rzeczywistych czasów firm';
            });
        });
    };
    
    // Initialize event handlers for the filter form
    const initializeEventHandlers = () => {
        // Period selector changes date ranges
        const periodSelector = document.getElementById('period');
        if (periodSelector) {
            periodSelector.addEventListener('change', function() {
                updateDateFields(this.value);
            });
        }
        
        // Handle report generation
        handleGenerateReport();
        handleGenerateOrgReport();
    };
    
    // Initialize everything
    const charts = initializeAllCharts();
    initializeEventHandlers();
    
    // Make charts available globally for debugging
    window.statsCharts = charts;
});


</script>
{% endblock %}
